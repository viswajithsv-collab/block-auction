<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auction Dashboard - Instructor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 100%);
            min-height: 100vh; color: #fff; padding: 20px;
        }
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px; background: rgba(0,0,0,0.3); border-radius: 15px;
            margin-bottom: 20px; border: 1px solid #e94560;
        }
        .header h1 { color: #e94560; }
        .controls { display: flex; gap: 15px; align-items: center; }
        .btn {
            padding: 12px 25px; border: none; border-radius: 8px;
            cursor: pointer; font-weight: bold; font-size: 1em;
        }
        .btn-start { background: #4ecca3; color: #1a1a2e; }
        .btn-start:disabled { background: #555; cursor: not-allowed; color: #888; }
        .btn-freeze { background: #e94560; color: white; }
        .btn-freeze:disabled { background: #555; cursor: not-allowed; color: #888; }
        .btn-reset { background: #666; color: white; }
        .timer-display {
            font-size: 2.5em; font-family: monospace; color: #4ecca3;
            background: rgba(0,0,0,0.5); padding: 10px 30px; border-radius: 10px;
        }
        .timer-display.warning { color: #e94560; animation: pulse 1s infinite; }
        .timer-display.waiting { color: #888; }
        .timer-display.frozen { color: #e94560; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
        .status { padding: 5px 15px; border-radius: 15px; font-size: 0.9em; }
        .status.ok { background: #4ecca3; color: #1a1a2e; }
        .status.err { background: #e94560; }
        .auction-state {
            padding: 5px 15px; border-radius: 15px; font-size: 0.9em;
            font-weight: bold; text-transform: uppercase;
        }
        .auction-state.waiting { background: #888; color: #1a1a2e; }
        .auction-state.running { background: #4ecca3; color: #1a1a2e; }
        .auction-state.frozen { background: #e94560; color: white; }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab {
            padding: 10px 25px; background: rgba(255,255,255,0.1);
            border: none; border-radius: 8px; color: #fff; cursor: pointer;
        }
        .tab.active { background: #e94560; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .pot-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; }
        .pot-card {
            background: rgba(255,255,255,0.04); border-radius: 12px;
            overflow: hidden; border: 1px solid rgba(255,255,255,0.08);
        }
        .pot-card-header {
            padding: 10px 14px; background: rgba(0,0,0,0.2);
            display: flex; justify-content: space-between; align-items: center;
        }
        .pot-card-header h3 { color: #e94560; font-size: 0.95em; }
        .pot-card-header .meta { font-size: 0.72em; color: #888; }
        .pot-card-header .badge {
            background: rgba(233,69,96,0.2); color: #e94560;
            padding: 2px 7px; border-radius: 8px; font-weight: bold; font-size: 0.72em;
        }
        .pot-card-items { padding: 6px; }

        .live-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 7px 10px; margin: 3px 0; background: rgba(0,0,0,0.25);
            border-radius: 7px; font-size: 0.85em;
        }
        .live-item .name { color: #ddd; }
        .live-item .bid-count { font-weight: bold; min-width: 60px; text-align: right; }
        .live-item .bid-count.hot { color: #e94560; }
        .live-item .bid-count.warm { color: #ffc107; }
        .live-item .bid-count.cold { color: #666; }

        .winner-item {
            padding: 6px 10px; margin: 3px 0; background: rgba(0,0,0,0.25);
            border-radius: 7px; font-size: 0.85em;
        }
        .winner-item .item-label { color: #888; font-size: 0.85em; margin-bottom: 3px; }
        .winner-item .winner-names { color: #4ecca3; font-weight: bold; }
        .winner-item .no-bids { color: #555; }

        .team-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px; max-height: 600px; overflow-y: auto;
        }
        .team-card {
            background: rgba(0,0,0,0.3); border-radius: 10px;
            padding: 15px; border: 1px solid rgba(255,255,255,0.1);
        }
        .team-card h3 { color: #4ecca3; margin-bottom: 10px; font-size: 1em; }
        .team-card .stat { display: flex; justify-content: space-between; margin: 4px 0; font-size: 0.9em; }
        .team-card .stat .label { color: #888; }
        .panel {
            background: rgba(255,255,255,0.05); border-radius: 15px;
            padding: 20px; border: 1px solid rgba(255,255,255,0.1);
        }
        .panel h2 {
            color: #e94560; margin-bottom: 15px;
            padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        @media (max-width: 1400px) { .pot-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 1000px) { .pot-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ Auction Dashboard</h1>
        <div class="timer-display waiting" id="timer">WAITING</div>
        <div class="controls">
            <span class="auction-state waiting" id="auctionState">Waiting</span>
            <span class="status err" id="status">Connecting...</span>
            <button class="btn btn-start" id="startBtn" onclick="startAuction()">‚ñ∂ Start</button>
            <button class="btn btn-freeze" id="freezeBtn" onclick="freezeAuction()" disabled>‚è∏ Freeze</button>
            <button class="btn btn-reset" onclick="resetAuction()">‚Ü∫ Reset</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('live')">üìä Live View</button>
        <button class="tab" onclick="showTab('teams')">üë• Teams</button>
        <button class="tab" onclick="showTab('winners')">üèÜ Winners</button>
    </div>

    <div class="tab-content active" id="tab-live">
        <div class="pot-grid" id="liveGrid"></div>
    </div>

    <div class="tab-content" id="tab-teams">
        <div class="panel">
            <h2>üë• Team Details</h2>
            <div class="team-grid" id="teamGrid"></div>
        </div>
    </div>

    <div class="tab-content" id="tab-winners">
        <div class="pot-grid" id="winnersGrid"></div>
    </div>

<script>
var API = 'https://script.google.com/macros/s/AKfycbzkDs0CuxWXFru1w_AjoJ8r5TvyUNw4MSO50BwlSHDURR5Qv66_MDQXa_T2fU1RnBs/exec';
var DURATION = 15 * 60;

var POTS = [
  {id:"pot1",name:"Pot 1: Geometry",w:2,items:[
    {id:"G1",name:"a"},{id:"G2",name:"b"},{id:"G3",name:"\u03C1i"},{id:"G4",name:"\u03C1o"},
    {id:"G5",name:"ri formula"},{id:"G6",name:"ro formula"},{id:"G7",name:"Micrometer"},{id:"G8",name:"Impedance"}
  ]},
  {id:"pot2",name:"Pot 2: Resting Membrane",w:3,items:[
    {id:"R1",name:"g_leak"},{id:"R2",name:"E_rest"},{id:"R3",name:"K_leak formula"},
    {id:"R4",name:"Equilibrium"},{id:"R5",name:"Current clamp"},{id:"R6",name:"Voltage clamp"}
  ]},
  {id:"pot3",name:"Pot 3: Synapse",w:3,items:[
    {id:"S1",name:"g_syn(t)"},{id:"S2",name:"E_syn"},{id:"S3",name:"K_syn formula"},
    {id:"S4",name:"Transient"},{id:"S5",name:"Reversal expt"},{id:"S6",name:"Paired recording"}
  ]},
  {id:"pot4",name:"Pot 4: EPSP vs IPSP",w:2,items:[
    {id:"E1",name:"E_syn > E_rest"},{id:"E2",name:"E_syn < E_rest"},{id:"E3",name:"EPSP DF<0"},
    {id:"E4",name:"IPSP DF>0"},{id:"E5",name:"EPSP sink"},{id:"E6",name:"IPSP source"},
    {id:"E7",name:"Cation ch"},{id:"E8",name:"Cl- ch"}
  ]},
  {id:"pot5",name:"Pot 5: Ohm's Law",w:2,items:[
    {id:"O1",name:"Ii"},{id:"O2",name:"Io"},{id:"O3",name:"Vi"},{id:"O4",name:"Vo"},
    {id:"O5",name:"dVi/dz"},{id:"O6",name:"dVo/dz"},{id:"O7",name:"Current inj"},{id:"O8",name:"V gradient"}
  ]},
  {id:"pot6",name:"Pot 6: KCL",w:4,items:[
    {id:"K1",name:"dIi/dz"},{id:"K2",name:"dIo/dz"},{id:"K3",name:"Km sum"},
    {id:"K4",name:"Sink"},{id:"K5",name:"Source"}
  ]},
  {id:"pot7",name:"Pot 7: Membrane V",w:4,items:[
    {id:"M1",name:"Vm=Vi-Vo"},{id:"M2",name:"Vi=Vm+Vo"},{id:"M3",name:"Diff recording"},{id:"M4",name:"Vi approx Vm"}
  ]},
  {id:"pot8",name:"Pot 8: Electrodes",w:3,items:[
    {id:"L1",name:"Intra electrode"},{id:"L2",name:"Extra electrode"},{id:"L3",name:"ro>0"},
    {id:"L4",name:"EPSP polarity"},{id:"L5",name:"IPSP polarity"},{id:"L6",name:"dVo prop ro"}
  ]}
];

var ITEM_POT = {};
POTS.forEach(function(pot) { pot.items.forEach(function(item) { ITEM_POT[item.id] = pot; }); });

var allBids = {};
var auctionState = 'waiting'; // 'waiting', 'running', 'frozen'
var serverStartTime = 0;
var localTimerInterval = null;

function showTab(name) {
    document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
    document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.remove('active'); });
    document.querySelector('[onclick="showTab(\'' + name + '\')"]').classList.add('active');
    document.getElementById('tab-' + name).classList.add('active');
}

// =============================================
// AUCTION STATE CONTROL (writes to Google Sheets)
// =============================================

function startAuction() {
    if (auctionState === 'running') return;
    var startTime = Date.now();
    sendState('running', startTime, DURATION);
}

function freezeAuction() {
    if (auctionState !== 'running') return;
    sendState('frozen', serverStartTime, DURATION);
}

function resetAuction() {
    if (!confirm('Reset auction? All bids will be cleared.')) return;
    var script = document.createElement('script');
    var cb = 'reset_' + Date.now();
    window[cb] = function(data) {
        if (data && data.success) {
            alert('Auction reset!');
            allBids = {};
            auctionState = 'waiting';
            serverStartTime = 0;
            updateUIState();
            updateDisplays();
        }
        delete window[cb];
        script.remove();
    };
    script.src = API + '?action=resetAuction&callback=' + cb;
    script.onerror = function() { alert('Reset failed ‚Äî check connection.'); script.remove(); delete window[cb]; };
    document.body.appendChild(script);
}

function sendState(state, startTime, duration) {
    var script = document.createElement('script');
    var cb = 'state_' + Date.now();
    window[cb] = function(data) {
        if (data && data.success) {
            auctionState = state;
            serverStartTime = startTime;
            updateUIState();
            if (state === 'frozen') {
                showTab('winners');
            }
        }
        delete window[cb];
        script.remove();
    };
    script.src = API + '?action=setState&state=' + state +
        '&startTime=' + startTime + '&duration=' + duration + '&callback=' + cb;
    script.onerror = function() { alert('Failed to set state ‚Äî check connection.'); script.remove(); delete window[cb]; };
    document.body.appendChild(script);
}

// =============================================
// UI STATE SYNC
// =============================================

function updateUIState() {
    var timerEl = document.getElementById('timer');
    var stateEl = document.getElementById('auctionState');
    var startBtn = document.getElementById('startBtn');
    var freezeBtn = document.getElementById('freezeBtn');

    timerEl.classList.remove('waiting', 'warning', 'frozen');
    stateEl.classList.remove('waiting', 'running', 'frozen');

    if (auctionState === 'waiting') {
        timerEl.textContent = 'WAITING';
        timerEl.classList.add('waiting');
        stateEl.textContent = 'Waiting';
        stateEl.classList.add('waiting');
        startBtn.disabled = false;
        freezeBtn.disabled = true;
    } else if (auctionState === 'running') {
        stateEl.textContent = 'Running';
        stateEl.classList.add('running');
        startBtn.disabled = true;
        freezeBtn.disabled = false;
        updateTimerDisplay();
    } else if (auctionState === 'frozen') {
        timerEl.textContent = 'FROZEN';
        timerEl.classList.add('frozen');
        stateEl.textContent = 'Frozen';
        stateEl.classList.add('frozen');
        startBtn.disabled = true;
        freezeBtn.disabled = true;
    }
}

function updateTimerDisplay() {
    if (auctionState !== 'running' || !serverStartTime) return;
    var elapsed = Math.floor((Date.now() - serverStartTime) / 1000);
    var remaining = Math.max(0, DURATION - elapsed);

    var m = Math.floor(remaining / 60);
    var s = remaining % 60;
    var timerEl = document.getElementById('timer');
    timerEl.textContent = m.toString().padStart(2,'0') + ':' + s.toString().padStart(2,'0');

    if (remaining < 120) timerEl.classList.add('warning');
    else timerEl.classList.remove('warning');

    if (remaining <= 0) {
        // Auto-freeze when time expires
        freezeAuction();
    }
}

// =============================================
// POLLING ‚Äî bids + state
// =============================================

function pollBids() {
    var script = document.createElement('script');
    var cb = 'cb_' + Date.now();
    window[cb] = function(data) {
        if (data && data.bids) {
            allBids = data.bids;
            updateDisplays();
            setStatus(true);
        }
        delete window[cb];
        script.remove();
    };
    script.src = API + '?action=getAllBids&callback=' + cb;
    script.onerror = function() { setStatus(false); script.remove(); delete window[cb]; };
    document.body.appendChild(script);
}

function pollState() {
    var script = document.createElement('script');
    var cb = 'st_' + Date.now();
    window[cb] = function(data) {
        if (data && data.success) {
            var newState = data.state || 'waiting';
            var newStart = Number(data.startTime) || 0;
            // Update if changed
            if (newState !== auctionState || newStart !== serverStartTime) {
                auctionState = newState;
                serverStartTime = newStart;
                if (data.duration) DURATION = Number(data.duration);
                updateUIState();
            }
        }
        delete window[cb];
        script.remove();
    };
    script.src = API + '?action=getState&callback=' + cb;
    script.onerror = function() { script.remove(); delete window[cb]; };
    document.body.appendChild(script);
}

function setStatus(ok) {
    var el = document.getElementById('status');
    el.textContent = ok ? 'Connected' : 'Offline';
    el.className = 'status ' + (ok ? 'ok' : 'err');
}

function updateDisplays() {
    renderLiveGrid();
    renderTeamGrid();
    renderWinners();
}

// =============================================
// LIVE VIEW
// =============================================

function renderLiveGrid() {
    var grid = document.getElementById('liveGrid');
    grid.innerHTML = POTS.map(function(pot) {
        return '<div class="pot-card">' +
            '<div class="pot-card-header">' +
            '<h3>' + pot.name + '</h3>' +
            '<span class="badge">Top ' + pot.w + '</span>' +
            '</div>' +
            '<div class="pot-card-items">' +
            pot.items.map(function(item) {
                var bids = allBids[item.id] || {};
                var count = Object.values(bids).filter(function(b){return b > 0;}).length;
                var cls = count >= 5 ? 'hot' : count >= 2 ? 'warm' : 'cold';
                return '<div class="live-item">' +
                    '<span class="name">' + item.id + ': ' + item.name + '</span>' +
                    '<span class="bid-count ' + cls + '">' + count + ' team' + (count !== 1 ? 's' : '') + '</span>' +
                    '</div>';
            }).join('') +
            '</div></div>';
    }).join('');
}

// =============================================
// TEAM GRID
// =============================================

function renderTeamGrid() {
    var teams = {};
    Object.keys(allBids).forEach(function(itemId) {
        var bids = allBids[itemId];
        Object.keys(bids).forEach(function(team) {
            if (!teams[team]) teams[team] = { total: 0, items: 0, winning: 0, pots: {} };
            if (bids[team] > 0) {
                teams[team].total += bids[team];
                teams[team].items++;
                if (ITEM_POT[itemId]) teams[team].pots[ITEM_POT[itemId].id] = true;
            }
        });
    });

    POTS.forEach(function(pot) {
        pot.items.forEach(function(item) {
            var bids = allBids[item.id] || {};
            var sorted = Object.entries(bids).sort(function(a,b){return b[1]-a[1];});
            var winners = sorted.slice(0, pot.w).map(function(e){return e[0];});
            winners.forEach(function(w) { if (teams[w]) teams[w].winning++; });
        });
    });

    var html = Object.keys(teams).sort().map(function(name) {
        var d = teams[name];
        var potCount = Object.keys(d.pots).length;
        return '<div class="team-card">' +
            '<h3>' + name + '</h3>' +
            '<div class="stat"><span class="label">Points:</span><span>' + d.total + '</span></div>' +
            '<div class="stat"><span class="label">Items bid:</span><span>' + d.items + '</span></div>' +
            '<div class="stat"><span class="label">Winning:</span><span>' + d.winning + '</span></div>' +
            '<div class="stat"><span class="label">Pots:</span><span>' + potCount + '/8</span></div>' +
            '</div>';
    }).join('');

    document.getElementById('teamGrid').innerHTML = html || '<p style="color:#888">No teams yet...</p>';
}

// =============================================
// WINNERS
// =============================================

function renderWinners() {
    var grid = document.getElementById('winnersGrid');
    grid.innerHTML = POTS.map(function(pot) {
        return '<div class="pot-card">' +
            '<div class="pot-card-header">' +
            '<h3>' + pot.name + '</h3>' +
            '<span class="badge">Top ' + pot.w + '</span>' +
            '</div>' +
            '<div class="pot-card-items">' +
            pot.items.map(function(item) {
                var bids = allBids[item.id] || {};
                var sorted = Object.entries(bids).sort(function(a,b){return b[1]-a[1];});
                var winners = sorted.slice(0, pot.w).map(function(e){return e[0];});
                return '<div class="winner-item">' +
                    '<div class="item-label">' + item.id + ': ' + item.name + '</div>' +
                    (winners.length > 0 ?
                        '<div class="winner-names">' + winners.join(', ') + '</div>' :
                        '<div class="no-bids">No bids</div>') +
                    '</div>';
            }).join('') +
            '</div></div>';
    }).join('');
}

// =============================================
// INIT
// =============================================

// Poll state + bids immediately
pollState();
pollBids();

// Poll bids every 2s, state every 3s
setInterval(pollBids, 2000);
setInterval(pollState, 3000);

// Update timer display every second
setInterval(updateTimerDisplay, 1000);
</script>
</body>
</html>
