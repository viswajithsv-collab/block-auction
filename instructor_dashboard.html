<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auction Dashboard - Instructor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 100%);
            min-height: 100vh; color: #fff; padding: 20px;
        }
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px; background: rgba(0,0,0,0.3); border-radius: 15px;
            margin-bottom: 20px; border: 1px solid #e94560;
        }
        .header h1 { color: #e94560; }
        .controls { display: flex; gap: 15px; align-items: center; }
        .btn {
            padding: 12px 25px; border: none; border-radius: 8px;
            cursor: pointer; font-weight: bold; font-size: 1em;
        }
        .btn-start { background: #4ecca3; color: #1a1a2e; }
        .btn-freeze { background: #e94560; color: white; }
        .btn-reset { background: #666; color: white; }
        .timer-display {
            font-size: 2.5em; font-family: monospace; color: #4ecca3;
            background: rgba(0,0,0,0.5); padding: 10px 30px; border-radius: 10px;
        }
        .timer-display.warning { color: #e94560; animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
        .status { padding: 5px 15px; border-radius: 15px; font-size: 0.9em; }
        .status.ok { background: #4ecca3; color: #1a1a2e; }
        .status.err { background: #e94560; }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab {
            padding: 10px 25px; background: rgba(255,255,255,0.1);
            border: none; border-radius: 8px; color: #fff; cursor: pointer;
        }
        .tab.active { background: #e94560; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Pot grid (shared by live view and winners) */
        .pot-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; }
        .pot-card {
            background: rgba(255,255,255,0.04); border-radius: 12px;
            overflow: hidden; border: 1px solid rgba(255,255,255,0.08);
        }
        .pot-card-header {
            padding: 10px 14px; background: rgba(0,0,0,0.2);
            display: flex; justify-content: space-between; align-items: center;
        }
        .pot-card-header h3 { color: #e94560; font-size: 0.95em; }
        .pot-card-header .meta { font-size: 0.72em; color: #888; }
        .pot-card-header .badge {
            background: rgba(233,69,96,0.2); color: #e94560;
            padding: 2px 7px; border-radius: 8px; font-weight: bold; font-size: 0.72em;
        }
        .pot-card-items { padding: 6px; }

        /* Live view items */
        .live-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 7px 10px; margin: 3px 0; background: rgba(0,0,0,0.25);
            border-radius: 7px; font-size: 0.85em;
        }
        .live-item .name { color: #ddd; }
        .live-item .bid-count { font-weight: bold; min-width: 60px; text-align: right; }
        .live-item .bid-count.hot { color: #e94560; }
        .live-item .bid-count.warm { color: #ffc107; }
        .live-item .bid-count.cold { color: #666; }

        /* Winner items */
        .winner-item {
            padding: 6px 10px; margin: 3px 0; background: rgba(0,0,0,0.25);
            border-radius: 7px; font-size: 0.85em;
        }
        .winner-item .item-label { color: #888; font-size: 0.85em; margin-bottom: 3px; }
        .winner-item .winner-names { color: #4ecca3; font-weight: bold; }
        .winner-item .no-bids { color: #555; }

        /* Team grid */
        .team-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px; max-height: 600px; overflow-y: auto;
        }
        .team-card {
            background: rgba(0,0,0,0.3); border-radius: 10px;
            padding: 15px; border: 1px solid rgba(255,255,255,0.1);
        }
        .team-card h3 { color: #4ecca3; margin-bottom: 10px; font-size: 1em; }
        .team-card .stat { display: flex; justify-content: space-between; margin: 4px 0; font-size: 0.9em; }
        .team-card .stat .label { color: #888; }
        .panel {
            background: rgba(255,255,255,0.05); border-radius: 15px;
            padding: 20px; border: 1px solid rgba(255,255,255,0.1);
        }
        .panel h2 {
            color: #e94560; margin-bottom: 15px;
            padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        @media (max-width: 1400px) { .pot-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 1000px) { .pot-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ Auction Dashboard</h1>
        <div class="timer-display" id="timer">15:00</div>
        <div class="controls">
            <span class="status err" id="status">Connecting...</span>
            <button class="btn btn-start" onclick="startAuction()">‚ñ∂ Start</button>
            <button class="btn btn-freeze" onclick="freezeAuction()">‚èπ Freeze</button>
            <button class="btn btn-reset" onclick="resetAuction()">‚Ü∫ Reset</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('live')">üìä Live View</button>
        <button class="tab" onclick="showTab('teams')">üë• Teams</button>
        <button class="tab" onclick="showTab('winners')">üèÜ Winners</button>
    </div>

    <div class="tab-content active" id="tab-live">
        <div class="pot-grid" id="liveGrid"></div>
    </div>

    <div class="tab-content" id="tab-teams">
        <div class="panel">
            <h2>üë• Team Details</h2>
            <div class="team-grid" id="teamGrid"></div>
        </div>
    </div>

    <div class="tab-content" id="tab-winners">
        <div class="pot-grid" id="winnersGrid"></div>
    </div>

<script>
var API = 'https://script.google.com/macros/s/AKfycbzkDs0CuxWXFru1w_AjoJ8r5TvyUNw4MSO50BwlSHDURR5Qv66_MDQXa_T2fU1RnBs/exec';
var DURATION = 15 * 60;

var POTS = [
  {id:"pot1",name:"Pot 1: Geometry",w:2,items:[
    {id:"G1",name:"a (axon radius)"},{id:"G2",name:"b (outer boundary)"},{id:"G3",name:"\u03C1\u1D62 (cytoplasm resistivity)"},{id:"G4",name:"\u03C1\u2092 (extracellular resistivity)"},
    {id:"G5",name:"r\u1D62 = \u03C1\u1D62 / \u03C0a\u00B2"},{id:"G6",name:"r\u2092 = \u03C1\u2092 / \u03C0(b\u00B2\u2212a\u00B2)"},{id:"G7",name:"Micrometer \u2192 a, b"},{id:"G8",name:"Impedance \u2192 r\u1D62, r\u2092"}
  ]},
  {id:"pot2",name:"Pot 2: Resting Membrane",w:3,items:[
    {id:"R1",name:"g_leak (leak conductance)"},{id:"R2",name:"E_rest (resting potential)"},{id:"R3",name:"K_leak = g_leak(V\u2098 \u2212 E_rest)"},
    {id:"R4",name:"At rest: V\u2098 = E_rest, K_leak = 0"},{id:"R5",name:"Current clamp \u2192 R\u2098"},{id:"R6",name:"Voltage clamp \u2192 g_leak"}
  ]},
  {id:"pot3",name:"Pot 3: Synapse",w:3,items:[
    {id:"S1",name:"g_syn(t) (synaptic conductance)"},{id:"S2",name:"E_syn (reversal potential)"},{id:"S3",name:"K_syn = g_syn(t)\u00B7(V\u2098 \u2212 E_syn)"},
    {id:"S4",name:"g_syn(t) is transient"},{id:"S5",name:"Reversal potential expt"},{id:"S6",name:"Paired recording"}
  ]},
  {id:"pot4",name:"Pot 4: EPSP vs IPSP",w:2,items:[
    {id:"E1",name:"E_syn(EPSP) > E_rest"},{id:"E2",name:"E_syn(IPSP) < E_rest"},{id:"E3",name:"EPSP: (V\u2098 \u2212 E_syn) < 0"},
    {id:"E4",name:"IPSP: (V\u2098 \u2212 E_syn) > 0"},{id:"E5",name:"EPSP \u2192 K_syn < 0 (sink)"},
    {id:"E6",name:"IPSP \u2192 K_syn > 0 (source)"},{id:"E7",name:"Cation channels (Na\u207A/K\u207A)"},{id:"E8",name:"Cl\u207B channels"}
  ]},
  {id:"pot5",name:"Pot 5: Ohm\u2019s Law",w:2,items:[
    {id:"O1",name:"I\u1D62 (intracellular current)"},{id:"O2",name:"I\u2092 (extracellular current)"},{id:"O3",name:"V\u1D62 (intracellular potential)"},{id:"O4",name:"V\u2092 (extracellular potential)"},
    {id:"O5",name:"\u2202V\u1D62/\u2202z = \u2212r\u1D62I\u1D62"},{id:"O6",name:"\u2202V\u2092/\u2202z = \u2212r\u2092I\u2092"},{id:"O7",name:"Current injection method"},{id:"O8",name:"Voltage gradient method"}
  ]},
  {id:"pot6",name:"Pot 6: KCL",w:4,items:[
    {id:"K1",name:"\u2202I\u1D62/\u2202z = \u2212K\u2098"},{id:"K2",name:"\u2202I\u2092/\u2202z = K\u2098"},
    {id:"K3",name:"K\u2098 = K_leak + K_syn"},{id:"K4",name:"Sink: K\u2098 < 0 (inward)"},{id:"K5",name:"Source: K\u2098 > 0 (outward)"}
  ]},
  {id:"pot7",name:"Pot 7: Membrane V",w:4,items:[
    {id:"M1",name:"V\u2098 = V\u1D62 \u2212 V\u2092"},{id:"M2",name:"V\u1D62 = V\u2098 + V\u2092"},{id:"M3",name:"Differential recording"},{id:"M4",name:"V\u1D62 \u2248 V\u2098 when r\u2092 \u226A r\u1D62"}
  ]},
  {id:"pot8",name:"Pot 8: Electrodes",w:3,items:[
    {id:"L1",name:"Intracellular electrode \u2192 V\u1D62"},{id:"L2",name:"Extracellular electrode \u2192 V\u2092"},{id:"L3",name:"r\u2092 > 0 required for V\u2092 signal"},
    {id:"L4",name:"EPSP: V\u1D62 \u2191, V\u2092 \u2193"},{id:"L5",name:"IPSP: V\u1D62 \u2193, V\u2092 \u2191"},{id:"L6",name:"\u0394V\u2092 \u221D r\u2092"}
  ]}
];

var ITEM_POT = {};
POTS.forEach(function(pot) { pot.items.forEach(function(item) { ITEM_POT[item.id] = pot; }); });

var allBids = {};
var timeLeft = DURATION;
var timerInterval = null;
var running = false;

function showTab(name) {
    document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
    document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.remove('active'); });
    document.querySelector('[onclick="showTab(\'' + name + '\')"]').classList.add('active');
    document.getElementById('tab-' + name).classList.add('active');
}

function startAuction() {
    if (running) return;
    running = true;
    timerInterval = setInterval(function() {
        if (timeLeft <= 0) { freezeAuction(); return; }
        timeLeft--;
        updateTimer();
    }, 1000);
}

function freezeAuction() {
    running = false;
    if (timerInterval) clearInterval(timerInterval);
    document.getElementById('timer').textContent = 'FROZEN';
    document.getElementById('timer').classList.add('warning');
    showTab('winners');
}

function resetAuction() {
    if (!confirm('Reset auction? All bids will be cleared.')) return;
    var script = document.createElement('script');
    var cb = 'reset_' + Date.now();
    window[cb] = function() {
        alert('Auction reset!');
        allBids = {};
        timeLeft = DURATION;
        running = false;
        if (timerInterval) clearInterval(timerInterval);
        updateTimer();
        document.getElementById('timer').classList.remove('warning');
        updateDisplays();
        delete window[cb];
    };
    script.src = API + '?action=resetAuction&callback=' + cb;
    document.body.appendChild(script);
}

function updateTimer() {
    var m = Math.floor(timeLeft / 60);
    var s = timeLeft % 60;
    document.getElementById('timer').textContent = m.toString().padStart(2,'0') + ':' + s.toString().padStart(2,'0');
    if (timeLeft < 120) document.getElementById('timer').classList.add('warning');
}

// --- POLLING ---
function poll() {
    var script = document.createElement('script');
    var cb = 'cb_' + Date.now();
    window[cb] = function(data) {
        if (data && data.bids) {
            allBids = data.bids;
            updateDisplays();
            setStatus(true);
        }
        delete window[cb];
        script.remove();
    };
    script.src = API + '?action=getAllBids&callback=' + cb;
    script.onerror = function() { setStatus(false); script.remove(); delete window[cb]; };
    document.body.appendChild(script);
}

function setStatus(ok) {
    var el = document.getElementById('status');
    el.textContent = ok ? 'Connected' : 'Offline';
    el.className = 'status ' + (ok ? 'ok' : 'err');
}

function updateDisplays() {
    renderLiveGrid();
    renderTeamGrid();
    renderWinners();
}

// --- LIVE VIEW: 4-col pot grid with bid counts ---
function renderLiveGrid() {
    var grid = document.getElementById('liveGrid');
    grid.innerHTML = POTS.map(function(pot) {
        return '<div class="pot-card">' +
            '<div class="pot-card-header">' +
            '<h3>' + pot.name + '</h3>' +
            '<span class="badge">Top ' + pot.w + '</span>' +
            '</div>' +
            '<div class="pot-card-items">' +
            pot.items.map(function(item) {
                var bids = allBids[item.id] || {};
                var count = Object.values(bids).filter(function(b){return b > 0;}).length;
                var cls = count >= 5 ? 'hot' : count >= 2 ? 'warm' : 'cold';
                return '<div class="live-item">' +
                    '<span class="name">' + item.id + ': ' + item.name + '</span>' +
                    '<span class="bid-count ' + cls + '">' + count + ' team' + (count !== 1 ? 's' : '') + '</span>' +
                    '</div>';
            }).join('') +
            '</div></div>';
    }).join('');
}

// --- TEAM GRID ---
function renderTeamGrid() {
    var teams = {};
    Object.keys(allBids).forEach(function(itemId) {
        var bids = allBids[itemId];
        Object.keys(bids).forEach(function(team) {
            if (!teams[team]) teams[team] = { total: 0, items: 0, winning: 0, pots: {} };
            if (bids[team] > 0) {
                teams[team].total += bids[team];
                teams[team].items++;
                if (ITEM_POT[itemId]) teams[team].pots[ITEM_POT[itemId].id] = true;
            }
        });
    });

    // Count winning
    POTS.forEach(function(pot) {
        pot.items.forEach(function(item) {
            var bids = allBids[item.id] || {};
            var sorted = Object.entries(bids).sort(function(a,b){return b[1]-a[1];});
            var winners = sorted.slice(0, pot.w).map(function(e){return e[0];});
            winners.forEach(function(w) { if (teams[w]) teams[w].winning++; });
        });
    });

    var html = Object.keys(teams).map(function(name) {
        var d = teams[name];
        var potCount = Object.keys(d.pots).length;
        return '<div class="team-card">' +
            '<h3>' + name + '</h3>' +
            '<div class="stat"><span class="label">Points:</span><span>' + d.total + '</span></div>' +
            '<div class="stat"><span class="label">Items bid:</span><span>' + d.items + '</span></div>' +
            '<div class="stat"><span class="label">Winning:</span><span>' + d.winning + '</span></div>' +
            '<div class="stat"><span class="label">Pots:</span><span>' + potCount + '/8</span></div>' +
            '</div>';
    }).join('');

    document.getElementById('teamGrid').innerHTML = html || '<p style="color:#888">No teams yet...</p>';
}

// --- WINNERS: 4-col grid, team names only ---
function renderWinners() {
    var grid = document.getElementById('winnersGrid');
    grid.innerHTML = POTS.map(function(pot) {
        return '<div class="pot-card">' +
            '<div class="pot-card-header">' +
            '<h3>' + pot.name + '</h3>' +
            '<span class="badge">Top ' + pot.w + '</span>' +
            '</div>' +
            '<div class="pot-card-items">' +
            pot.items.map(function(item) {
                var bids = allBids[item.id] || {};
                var sorted = Object.entries(bids).sort(function(a,b){return b[1]-a[1];});
                var winners = sorted.slice(0, pot.w).map(function(e){return e[0];});
                return '<div class="winner-item">' +
                    '<div class="item-label">' + item.id + ': ' + item.name + '</div>' +
                    (winners.length > 0 ?
                        '<div class="winner-names">' + winners.join(', ') + '</div>' :
                        '<div class="no-bids">No bids</div>') +
                    '</div>';
            }).join('') +
            '</div></div>';
    }).join('');
}

// Init
poll();
setInterval(poll, 2000);
</script>
</body>
</html>
