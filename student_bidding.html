<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Block Diagram Auction ‚Äî Studio 1</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 100%);
            min-height: 100vh; color: #fff;
        }
        .login-screen {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; height: 100vh; gap: 15px;
        }
        .login-screen h1 { color: #e94560; font-size: 2.2em; }
        .login-screen p { color: #aaa; margin-bottom: 10px; }
        .login-screen .team-select-label { color: #ccc; font-size: 1.1em; margin-top: 10px; }
        .team-grid {
            display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px;
            max-width: 500px; width: 100%; padding: 0 20px;
        }
        .team-btn {
            padding: 16px 10px; font-size: 1.3em; font-weight: bold;
            background: rgba(255,255,255,0.06); color: #ccc;
            border: 2px solid #444; border-radius: 12px; cursor: pointer;
            transition: all 0.2s;
        }
        .team-btn:hover { border-color: #e94560; color: #fff; background: rgba(233,69,96,0.15); transform: scale(1.05); }
        .team-btn:active { transform: scale(0.95); }
        .team-btn.selected { border-color: #e94560; background: #e94560; color: #fff; }
        .join-btn {
            padding: 14px 50px; font-size: 1.1em; background: #444;
            color: #888; border: none; border-radius: 10px; cursor: not-allowed;
            transition: all 0.2s; margin-top: 5px;
        }
        .join-btn.ready { background: #e94560; color: white; cursor: pointer; }
        .join-btn.ready:hover { background: #d63050; }

        /* WAITING SCREEN ‚Äî shown after login, before instructor starts */
        .waiting-screen {
            display: none; flex-direction: column; align-items: center;
            justify-content: center; height: 100vh; gap: 20px;
        }
        .waiting-screen.active { display: flex; }
        .waiting-screen h2 { color: #e94560; font-size: 1.8em; }
        .waiting-screen p { color: #888; font-size: 1.1em; }
        .waiting-screen .team-badge-large {
            background: #e94560; padding: 8px 24px; border-radius: 15px;
            font-weight: bold; font-size: 1.1em;
        }
        .waiting-pulse {
            width: 60px; height: 60px; border-radius: 50%;
            background: rgba(233,69,96,0.2); position: relative;
        }
        .waiting-pulse::after {
            content: ''; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%,-50%); width: 20px; height: 20px;
            border-radius: 50%; background: #e94560;
            animation: waitPulse 2s infinite;
        }
        @keyframes waitPulse {
            0% { box-shadow: 0 0 0 0 rgba(233,69,96,0.6); }
            70% { box-shadow: 0 0 0 25px rgba(233,69,96,0); }
            100% { box-shadow: 0 0 0 0 rgba(233,69,96,0); }
        }
        .waiting-status { padding: 4px 12px; border-radius: 12px; font-size: 0.8em; }
        .waiting-status.ok { background: #4ecca3; color: #1a1a2e; }
        .waiting-status.err { background: #e94560; }

        .main-content { display: none; padding: 15px; padding-bottom: 100px; }
        .main-content.active { display: block; }

        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; background: rgba(0,0,0,0.3); border-radius: 12px;
            margin-bottom: 15px; border: 1px solid #e94560;
        }
        .header h1 { color: #e94560; font-size: 1.3em; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .team-badge { background: #e94560; padding: 5px 14px; border-radius: 15px; font-weight: bold; font-size: 0.9em; }
        .timer-display {
            font-size: 1.8em; font-family: monospace; color: #4ecca3;
            background: rgba(0,0,0,0.5); padding: 6px 20px; border-radius: 8px;
        }
        .timer-display.warning { color: #e94560; animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
        .status { padding: 4px 12px; border-radius: 12px; font-size: 0.8em; }
        .status.ok { background: #4ecca3; color: #1a1a2e; }
        .status.err { background: #e94560; }

        .pots-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; }
        .pot-card {
            background: rgba(255,255,255,0.04); border-radius: 12px;
            overflow: hidden; border: 1px solid rgba(255,255,255,0.08);
        }
        .pot-header {
            padding: 10px 14px; background: rgba(0,0,0,0.2);
            display: flex; justify-content: space-between; align-items: center;
        }
        .pot-header h3 { color: #e94560; font-size: 0.95em; }
        .pot-meta { display: flex; gap: 8px; font-size: 0.72em; color: #888; }
        .winners-badge {
            background: rgba(233,69,96,0.2); color: #e94560;
            padding: 2px 7px; border-radius: 8px; font-weight: bold;
        }
        .pot-items { padding: 6px; }
        .item-row {
            display: flex; align-items: center; padding: 7px 10px; margin: 3px 0;
            background: rgba(0,0,0,0.25); border-radius: 7px;
            border: 1px solid transparent; gap: 8px; transition: all 0.2s;
        }
        .item-row.has-bid { border-color: rgba(78,204,163,0.4); background: rgba(78,204,163,0.06); }
        .item-row.winning { border-color: #4ecca3; }
        .item-row.outbid { border-color: rgba(233,69,96,0.4); background: rgba(233,69,96,0.06); }
        .item-id { font-family: monospace; font-size: 0.72em; color: #888; min-width: 24px; }
        .item-info { flex: 1; min-width: 0; }
        .item-name { font-size: 0.88em; font-weight: 600; color: #ddd; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-desc { font-size: 0.7em; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-status { font-size: 0.7em; color: #888; min-width: 55px; text-align: right; }
        .item-status .high { color: #e94560; font-weight: bold; }
        .bid-input {
            width: 52px; padding: 5px 3px; text-align: center;
            border: 1px solid #444; border-radius: 5px;
            background: rgba(0,0,0,0.4); color: #fff;
            font-size: 0.9em; font-weight: bold; outline: none;
        }
        .bid-input:focus { border-color: #4ecca3; }
        .bid-input.has-value { border-color: #4ecca3; background: rgba(78,204,163,0.1); }

        .submit-section {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.9); padding: 12px 24px;
            display: flex; justify-content: space-between; align-items: center;
            border-top: 2px solid #e94560; z-index: 100;
        }
        .budget-info { display: flex; gap: 20px; font-size: 0.9em; color: #888; }
        .budget-info strong { color: #4ecca3; }
        .budget-info strong.over { color: #ff4444; }
        .btn {
            padding: 10px 30px; font-size: 1em; border: none; border-radius: 8px;
            cursor: pointer; font-weight: bold;
        }
        .btn:disabled { background: #555; cursor: not-allowed; color: #888; }
        .btn-update { background: #4ecca3; color: #1a1a2e; }
        .btn-final { background: #e94560; color: white; }
        .btn-results { background: #9b59b6; color: white; display: none; }
        .btn-back { background: #666; color: white; }
        .btn-group { display: flex; gap: 10px; }

        .frozen .bid-input { pointer-events: none; opacity: 0.5; }
        .frozen .btn-update { display: none; }
        .frozen .btn-final { display: none; }
        .frozen .btn-results { display: inline-block; }

        /* Results view */
        .results-view { display: none; }
        .results-view.active { display: block; }
        .bidding-view.hidden { display: none; }
        .results-summary {
            text-align: center; padding: 20px; margin-bottom: 15px;
            background: rgba(0,0,0,0.3); border-radius: 12px; border: 1px solid #e94560;
        }
        .results-summary h2 { color: #e94560; font-size: 1.5em; margin-bottom: 8px; }
        .results-summary .stats { font-size: 1.1em; color: #aaa; }
        .results-summary .stats .won { color: #4ecca3; font-weight: bold; }
        .results-summary .stats .lost { color: #e94560; font-weight: bold; }
        .results-summary .stats .gap { color: #ff4444; font-weight: bold; }
        .results-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; }
        .result-pot {
            background: rgba(255,255,255,0.04); border-radius: 12px;
            overflow: hidden; border: 1px solid rgba(255,255,255,0.08);
        }
        .result-pot.covered { border-color: rgba(78,204,163,0.4); }
        .result-pot.missing { border-color: rgba(255,68,68,0.4); }
        .result-pot-header {
            padding: 10px 14px; display: flex; justify-content: space-between; align-items: center;
        }
        .result-pot.covered .result-pot-header { background: rgba(78,204,163,0.1); }
        .result-pot.missing .result-pot-header { background: rgba(255,68,68,0.1); }
        .result-pot-header h3 { font-size: 0.95em; }
        .result-pot.covered .result-pot-header h3 { color: #4ecca3; }
        .result-pot.missing .result-pot-header h3 { color: #ff4444; }
        .coverage-badge { font-size: 0.8em; font-weight: bold; padding: 2px 8px; border-radius: 8px; }
        .result-pot.covered .coverage-badge { background: rgba(78,204,163,0.2); color: #4ecca3; }
        .result-pot.missing .coverage-badge { background: rgba(255,68,68,0.2); color: #ff4444; }
        .result-items { padding: 6px; }
        .result-item {
            padding: 6px 10px; margin: 3px 0; border-radius: 6px; font-size: 0.85em;
            display: flex; justify-content: space-between; align-items: center;
        }
        .result-item.won { background: rgba(78,204,163,0.1); border: 1px solid rgba(78,204,163,0.3); color: #4ecca3; }
        .result-item.lost { background: rgba(233,69,96,0.1); border: 1px solid rgba(233,69,96,0.2); color: #e94560; }
        .result-item.no-bid { background: rgba(255,255,255,0.02); border: 1px solid transparent; color: #555; }
        .result-item .badge { font-size: 0.75em; font-weight: bold; }

        @media (max-width: 1400px) { .pots-grid, .results-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 1000px) { .pots-grid, .results-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .pots-grid, .results-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <!-- SCREEN 1: Team Selection -->
    <div class="login-screen" id="loginScreen">
        <h1>üèè Block Diagram Auction</h1>
        <p>Studio 1 ‚Äî Crayfish Axon Core Conductor Model</p>
        <div class="team-select-label">Select your team:</div>
        <div class="team-grid" id="teamGrid"></div>
        <button class="join-btn" id="joinBtn" onclick="joinAuction()">Select a team to join</button>
    </div>

    <!-- SCREEN 2: Waiting for Instructor to Start -->
    <div class="waiting-screen" id="waitingScreen">
        <span class="team-badge-large" id="waitingTeamBadge"></span>
        <div class="waiting-pulse"></div>
        <h2>Waiting for instructor to start the auction...</h2>
        <p>You're all set! The bidding will begin when your instructor clicks Start.</p>
        <span class="waiting-status ok" id="waitingStatus">Connected</span>
    </div>

    <!-- SCREEN 3: Bidding Interface -->
    <div class="main-content" id="mainContent">
        <div class="header">
            <h1>üèè Block Diagram Auction</h1>
            <div class="header-right">
                <span class="team-badge" id="teamBadge"></span>
                <span class="status err" id="status">Connecting...</span>
                <div class="timer-display" id="timer">15:00</div>
            </div>
        </div>

        <div class="bidding-view" id="biddingView">
            <div class="pots-grid" id="potsGrid"></div>
        </div>

        <div class="results-view" id="resultsView">
            <div class="results-summary" id="resultsSummary"></div>
            <div class="results-grid" id="resultsGrid"></div>
        </div>

        <div class="submit-section">
            <div class="budget-info">
                <span>Points: <strong id="pointsUsed">0</strong> / 100</span>
                <span>Items: <strong id="itemCount">0</strong></span>
                <span>Pots: <strong id="potsCovered">0</strong> / 8</span>
            </div>
            <div class="btn-group">
                <button class="btn btn-update" id="submitBtn" onclick="submitBids()">Update Bids</button>
                <button class="btn btn-final" id="finalBtn" onclick="finalSubmit()">üîí Submit Final Bids</button>
                <button class="btn btn-results" id="resultsBtn" onclick="showResults()">üìä View Results</button>
                <button class="btn btn-back" id="backBtn" onclick="showBidding()" style="display:none">‚Üê Back to Bids</button>
            </div>
        </div>
    </div>

<script>
var API = 'https://script.google.com/macros/s/AKfycbzkDs0CuxWXFru1w_AjoJ8r5TvyUNw4MSO50BwlSHDURR5Qv66_MDQXa_T2fU1RnBs/exec';
var BUDGET = 100;
var DURATION = 15 * 60; // Will be overwritten by server state

var POTS = [
  { id:"pot1", name:"Pot 1: Geometry", winnersPerItem:2, items:[
    {id:"G1",name:"a (axon radius)",desc:"Intracellular cross-section dimension"},
    {id:"G2",name:"b (extracellular boundary)",desc:"Extracellular cross-section dimension"},
    {id:"G3",name:"\u03C1\u1D62 (cytoplasm resistivity)",desc:"Material property of intracellular medium"},
    {id:"G4",name:"\u03C1\u2092 (extracellular resistivity)",desc:"Material property of extracellular medium"},
    {id:"G5",name:"r\u1D62 = \u03C1\u1D62 / \u03C0a\u00B2",desc:"Formula: geometry \u2192 r\u1D62"},
    {id:"G6",name:"r\u2092 = \u03C1\u2092 / \u03C0(b\u00B2\u2212a\u00B2)",desc:"Formula: geometry \u2192 r\u2092"},
    {id:"G7",name:"Micrometer + histology",desc:"Method: measure radii from tissue"},
    {id:"G8",name:"Impedance method",desc:"Bypasses geometry for r\u1D62, r\u2092"},
  ]},
  { id:"pot2", name:"Pot 2: Resting Membrane", winnersPerItem:3, items:[
    {id:"R1",name:"g_leak (leak conductance)",desc:"How leaky the membrane is"},
    {id:"R2",name:"E_rest (resting potential)",desc:"Equilibrium voltage"},
    {id:"R3",name:"K_leak = g_leak(Vm \u2212 E_rest)",desc:"Leak current formula"},
    {id:"R4",name:"At rest: Vm=E_rest",desc:"Equilibrium condition: K_leak=0"},
    {id:"R5",name:"Current clamp \u2192 Rm",desc:"Method: inject I, measure \u0394Vm"},
    {id:"R6",name:"Voltage clamp \u2192 g_leak",desc:"Method: command Vm, measure Im"},
  ]},
  { id:"pot3", name:"Pot 3: Synapse", winnersPerItem:3, items:[
    {id:"S1",name:"g_syn(t) (synaptic conductance)",desc:"Synapse on/off switch"},
    {id:"S2",name:"E_syn (reversal potential)",desc:"Where driving force = 0"},
    {id:"S3",name:"K_syn = g_syn(t)\u00B7(Vm \u2212 E_syn)",desc:"Synaptic current formula"},
    {id:"S4",name:"g_syn(t) is transient",desc:"Rises then falls"},
    {id:"S5",name:"Reversal potential expt",desc:"Method: vary Vm, find I_syn=0"},
    {id:"S6",name:"Paired recording",desc:"Method: stim pre, record post"},
  ]},
  { id:"pot4", name:"Pot 4: EPSP vs IPSP", winnersPerItem:2, items:[
    {id:"E1",name:"E_syn(EPSP) &gt; E_rest",desc:"Reversal above rest"},
    {id:"E2",name:"E_syn(IPSP) &lt; E_rest",desc:"Reversal below rest"},
    {id:"E3",name:"EPSP: (Vm\u2212E_syn) &lt; 0",desc:"Negative driving force"},
    {id:"E4",name:"IPSP: (Vm\u2212E_syn) &gt; 0",desc:"Positive driving force"},
    {id:"E5",name:"EPSP: inward current (sink)",desc:"K_syn &lt; 0, current into cell"},
    {id:"E6",name:"IPSP: outward current (source)",desc:"K_syn &gt; 0, current out of cell"},
    {id:"E7",name:"EPSP channels: cation",desc:"Na+/K+ channels"},
    {id:"E8",name:"IPSP channels: Cl\u207B (GABA)",desc:"Inhibitory ion mechanism"},
  ]},
  { id:"pot5", name:"Pot 5: Ohm's Law", winnersPerItem:2, items:[
    {id:"O1",name:"Ii (intracellular current)",desc:"Current inside axon"},
    {id:"O2",name:"Io (extracellular current)",desc:"Current outside axon"},
    {id:"O3",name:"Vi (intracellular potential)",desc:"Voltage inside"},
    {id:"O4",name:"Vo (extracellular potential)",desc:"Voltage outside"},
    {id:"O5",name:"\u2202Vi/\u2202z = \u2212riIi",desc:"Ohm's law intracellular"},
    {id:"O6",name:"\u2202Vo/\u2202z = \u2212roIo",desc:"Ohm's law extracellular"},
    {id:"O7",name:"Current injection method",desc:"Pass known I, measure \u0394V"},
    {id:"O8",name:"Voltage gradient method",desc:"Measure V at two z positions"},
  ]},
  { id:"pot6", name:"Pot 6: KCL / Conservation", winnersPerItem:4, items:[
    {id:"K1",name:"\u2202Ii/\u2202z = \u2212Km",desc:"Intracellular current continuity"},
    {id:"K2",name:"\u2202Io/\u2202z = Km",desc:"Extracellular current continuity"},
    {id:"K3",name:"Km = K_leak + K_syn",desc:"Total membrane current"},
    {id:"K4",name:"Sink: Km &lt; 0",desc:"Inward current meaning"},
    {id:"K5",name:"Source: Km &gt; 0",desc:"Outward current meaning"},
  ]},
  { id:"pot7", name:"Pot 7: Membrane Potential", winnersPerItem:4, items:[
    {id:"M1",name:"Vm = Vi \u2212 Vo",desc:"Membrane potential definition"},
    {id:"M2",name:"Vi = Vm + Vo",desc:"What intracellular electrode measures"},
    {id:"M3",name:"Differential recording",desc:"Method: simultaneous Vi and Vo"},
    {id:"M4",name:"Vi \u2248 Vm when ro \u226A ri",desc:"Approximation and when it breaks"},
  ]},
  { id:"pot8", name:"Pot 8: Electrodes & Recording", winnersPerItem:3, items:[
    {id:"L1",name:"Intracellular electrode",desc:"Measures Vi"},
    {id:"L2",name:"Extracellular electrode",desc:"Measures Vo"},
    {id:"L3",name:"ro &gt; 0 required for Vo",desc:"No signal if ro = 0"},
    {id:"L4",name:"EPSP: Vi\u2191, Vo\u2193",desc:"Opposite polarity (excitation)"},
    {id:"L5",name:"IPSP: Vi\u2193, Vo\u2191",desc:"Opposite polarity (inhibition)"},
    {id:"L6",name:"|\u0394Vo| \u221D ro",desc:"Larger ro = larger signal"},
  ]}
];

// Build item lookup
var ITEM_POT = {};
POTS.forEach(function(pot) { pot.items.forEach(function(item) { ITEM_POT[item.id] = pot; }); });

var teamName = '';
var bids = {};
var allBids = {};
var frozen = false;

// Auction state from server
var auctionState = 'waiting'; // 'waiting', 'running', 'frozen'
var serverStartTime = 0;
var hasJoined = false; // Has the student selected a team?

// --- TEAM NUMBERS (skip 13) ---
var TEAM_NUMBERS = [1,2,3,4,5,6,7,8,9,10,11,12,14,15,16,17,18,19];
var selectedTeam = null;

// Render team buttons
(function renderTeamGrid() {
    var grid = document.getElementById('teamGrid');
    TEAM_NUMBERS.forEach(function(num) {
        var btn = document.createElement('button');
        btn.className = 'team-btn';
        btn.textContent = num;
        btn.onclick = function() {
            document.querySelectorAll('.team-btn').forEach(function(b) { b.classList.remove('selected'); });
            btn.classList.add('selected');
            selectedTeam = num;
            var joinBtn = document.getElementById('joinBtn');
            joinBtn.textContent = 'Join as Team ' + num;
            joinBtn.classList.add('ready');
        };
        grid.appendChild(btn);
    });
})();

// =============================================
// LOGIN ‚Äî just selects team, does NOT start timer
// =============================================

function joinAuction() {
    if (!selectedTeam) return;
    teamName = 'Team ' + selectedTeam;
    hasJoined = true;

    // Hide login screen
    document.getElementById('loginScreen').style.display = 'none';

    // Check current auction state to decide what screen to show
    if (auctionState === 'running') {
        showBiddingScreen();
    } else if (auctionState === 'frozen') {
        showBiddingScreen();
        freeze();
    } else {
        // Show waiting screen
        showWaitingScreen();
    }
}

function showWaitingScreen() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('waitingScreen').classList.add('active');
    document.getElementById('mainContent').classList.remove('active');
    document.getElementById('waitingTeamBadge').textContent = teamName;
}

function showBiddingScreen() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('waitingScreen').classList.remove('active');
    document.getElementById('mainContent').classList.add('active');
    document.getElementById('teamBadge').textContent = teamName;

    // Only render pots once
    if (!document.getElementById('potsGrid').hasChildNodes()) {
        renderPots();
    }

    // Load existing bids for this team
    pollAndSync();
}

// =============================================
// STATE POLLING ‚Äî syncs auction state from server
// =============================================

function pollState() {
    var script = document.createElement('script');
    var cb = 'st_' + Date.now();
    window[cb] = function(data) {
        if (data && data.success) {
            var newState = data.state || 'waiting';
            var newStart = Number(data.startTime) || 0;
            var newDuration = Number(data.duration) || 900;

            var stateChanged = (newState !== auctionState);
            auctionState = newState;
            serverStartTime = newStart;
            DURATION = newDuration;

            // Update waiting screen connection indicator
            var wStatus = document.getElementById('waitingStatus');
            if (wStatus) {
                wStatus.textContent = 'Connected';
                wStatus.className = 'waiting-status ok';
            }

            if (stateChanged && hasJoined) {
                handleStateChange();
            }
        }
        delete window[cb];
        script.remove();
    };
    script.src = API + '?action=getState&callback=' + cb;
    script.onerror = function() {
        var wStatus = document.getElementById('waitingStatus');
        if (wStatus) {
            wStatus.textContent = 'Offline';
            wStatus.className = 'waiting-status err';
        }
        script.remove();
        delete window[cb];
    };
    document.body.appendChild(script);
}

function handleStateChange() {
    if (auctionState === 'running') {
        // Instructor started! Transition to bidding screen
        if (!frozen) {
            showBiddingScreen();
        }
    } else if (auctionState === 'frozen') {
        // Instructor froze! Lock bids
        if (!frozen) {
            doSubmit(); // Auto-submit whatever they have
            freeze();
        }
    } else if (auctionState === 'waiting') {
        // Auction was reset ‚Äî go back to waiting
        frozen = false;
        bids = {};
        allBids = {};
        showWaitingScreen();
    }
}

// =============================================
// TIMER ‚Äî calculated from server start time
// =============================================

function updateTimerDisplay() {
    if (auctionState !== 'running' || !serverStartTime) return;
    var elapsed = Math.floor((Date.now() - serverStartTime) / 1000);
    var remaining = Math.max(0, DURATION - elapsed);

    var m = Math.floor(remaining / 60);
    var s = remaining % 60;
    var el = document.getElementById('timer');
    if (!el) return;
    el.textContent = m.toString().padStart(2,'0') + ':' + s.toString().padStart(2,'0');

    if (remaining < 120) el.classList.add('warning');
    else el.classList.remove('warning');

    // If time runs out client-side, auto-submit and freeze
    // (The instructor dashboard or server will also freeze, but this ensures the student side locks too)
    if (remaining <= 0 && !frozen) {
        doSubmit();
        freeze();
    }
}

// =============================================
// RENDER POTS
// =============================================

function renderPots() {
    var grid = document.getElementById('potsGrid');
    grid.innerHTML = '';
    POTS.forEach(function(pot) {
        var wLabel = 'Top ' + pot.winnersPerItem + ' win';
        var card = document.createElement('div');
        card.className = 'pot-card';
        card.innerHTML =
            '<div class="pot-header">' +
                '<h3>' + pot.name + '</h3>' +
                '<div class="pot-meta">' +
                    '<span>' + pot.items.length + ' items</span>' +
                    '<span class="winners-badge">' + wLabel + '</span>' +
                '</div>' +
            '</div>' +
            '<div class="pot-items">' +
                pot.items.map(function(item) {
                    return '<div class="item-row" id="item-' + item.id + '">' +
                        '<span class="item-id">' + item.id + '</span>' +
                        '<div class="item-info">' +
                            '<div class="item-name">' + item.name + '</div>' +
                            '<div class="item-desc">' + item.desc + '</div>' +
                        '</div>' +
                        '<div class="item-status">' +
                            '<span id="high-' + item.id + '">\u2014</span>' +
                        '</div>' +
                        '<input type="number" class="bid-input" id="bid-' + item.id + '"' +
                            ' min="0" max="100" placeholder="0"' +
                            ' data-item="' + item.id + '"' +
                            ' onchange="updateBid(this)" oninput="updateBid(this)">' +
                    '</div>';
                }).join('') +
            '</div>';
        grid.appendChild(card);
    });
}

// =============================================
// BID MANAGEMENT
// =============================================

function updateBid(input) {
    if (frozen) return;
    var id = input.dataset.item;
    var val = parseInt(input.value) || 0;
    if (val > 0) { bids[id] = val; input.classList.add('has-value'); }
    else { delete bids[id]; input.classList.remove('has-value'); }
    updateStats();
    updateAllStatuses();
}

function updateStats() {
    var used = Object.values(bids).reduce(function(s,v){return s+v;}, 0);
    var count = Object.keys(bids).length;
    var pots = new Set();
    POTS.forEach(function(pot) { pot.items.forEach(function(item) { if (bids[item.id]) pots.add(pot.id); }); });
    var usedEl = document.getElementById('pointsUsed');
    if (!usedEl) return;
    usedEl.textContent = used;
    usedEl.className = used > BUDGET ? 'over' : '';
    document.getElementById('itemCount').textContent = count;
    document.getElementById('potsCovered').textContent = pots.size;
    var submitBtn = document.getElementById('submitBtn');
    var finalBtn = document.getElementById('finalBtn');
    if (submitBtn) submitBtn.disabled = used > BUDGET;
    if (finalBtn) finalBtn.disabled = used > BUDGET || used === 0;
}

function getTopN(itemId, n) {
    if (!allBids[itemId]) return [];
    return Object.entries(allBids[itemId])
        .sort(function(a,b) { return b[1] - a[1]; })
        .slice(0, n)
        .map(function(e) { return e[0]; });
}

function getHighBid(itemId) {
    if (!allBids[itemId]) return 0;
    return Math.max.apply(null, Object.values(allBids[itemId]).concat([0]));
}

function updateAllStatuses() {
    POTS.forEach(function(pot) { pot.items.forEach(function(item) {
        var row = document.getElementById('item-' + item.id);
        var highEl = document.getElementById('high-' + item.id);
        if (!row) return;
        var myBid = bids[item.id] || 0;
        var high = getHighBid(item.id);
        var winners = getTopN(item.id, pot.winnersPerItem);
        highEl.innerHTML = high > 0 ? '<span class="high">' + high + '</span>' : '\u2014';
        row.classList.remove('has-bid','winning','outbid');
        if (myBid > 0) {
            row.classList.add('has-bid');
            if (winners.indexOf(teamName) >= 0) row.classList.add('winning');
            else row.classList.add('outbid');
        }
    }); });
}

// =============================================
// SUBMIT
// =============================================

function submitBids() {
    if (frozen) return;
    var btn = document.getElementById('submitBtn');
    if (btn) btn.textContent = 'Saving...';
    doSubmit();
    setTimeout(function() { if (btn) btn.textContent = 'Update Bids'; poll(); }, 2000);
}

function finalSubmit() {
    if (frozen) return;
    var used = Object.values(bids).reduce(function(s,v){return s+v;}, 0);
    if (used > BUDGET) { alert('Over budget!'); return; }
    if (used === 0) { alert('Place at least one bid.'); return; }
    if (!confirm('Lock in your final bids? You will NOT be able to change them.')) return;
    doSubmit();
    freeze();
}

function freeze() {
    frozen = true;
    var main = document.getElementById('mainContent');
    if (main) main.classList.add('frozen');
    var timer = document.getElementById('timer');
    if (timer) {
        timer.textContent = 'LOCKED';
        timer.classList.add('warning');
    }
}

function doSubmit() {
    var form = document.createElement('form');
    form.method = 'POST';
    form.action = API;
    form.target = 'submitFrame';
    function addField(name, val) {
        var inp = document.createElement('input');
        inp.type = 'hidden'; inp.name = name; inp.value = val;
        form.appendChild(inp);
    }
    addField('action', 'submitBids');
    addField('teamName', teamName);
    addField('bids', JSON.stringify(bids));
    var iframe = document.getElementById('submitFrame');
    if (!iframe) {
        iframe = document.createElement('iframe');
        iframe.id = 'submitFrame'; iframe.name = 'submitFrame';
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
    }
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
}

// =============================================
// RESULTS VIEW
// =============================================

function showResults() {
    document.getElementById('biddingView').classList.add('hidden');
    document.getElementById('resultsView').classList.add('active');
    document.getElementById('resultsBtn').style.display = 'none';
    document.getElementById('backBtn').style.display = 'inline-block';
    renderResults();
}

function showBidding() {
    document.getElementById('biddingView').classList.remove('hidden');
    document.getElementById('resultsView').classList.remove('active');
    document.getElementById('resultsBtn').style.display = 'inline-block';
    document.getElementById('backBtn').style.display = 'none';
}

function renderResults() {
    var wonItems = [];
    var lostItems = [];
    var coveredPots = new Set();

    POTS.forEach(function(pot) {
        pot.items.forEach(function(item) {
            var winners = getTopN(item.id, pot.winnersPerItem);
            if (bids[item.id] && winners.indexOf(teamName) >= 0) {
                wonItems.push(item.id);
                coveredPots.add(pot.id);
            } else if (bids[item.id]) {
                lostItems.push(item.id);
            }
        });
    });

    var missingPots = POTS.filter(function(p) { return !coveredPots.has(p.id); });

    document.getElementById('resultsSummary').innerHTML =
        '<h2>Your Auction Results</h2>' +
        '<div class="stats">' +
        'Won <span class="won">' + wonItems.length + '</span> items | ' +
        'Lost <span class="lost">' + lostItems.length + '</span> items | ' +
        'Pots covered: <span class="' + (missingPots.length > 0 ? 'gap' : 'won') + '">' +
        coveredPots.size + '/8</span>' +
        (missingPots.length > 0 ? ' ‚Äî <span class="gap">Missing: ' +
            missingPots.map(function(p){return p.name;}).join(', ') + '</span>' : ' ‚Äî Full coverage!') +
        '</div>';

    var grid = document.getElementById('resultsGrid');
    grid.innerHTML = '';
    POTS.forEach(function(pot) {
        var hasCoverage = coveredPots.has(pot.id);
        var card = document.createElement('div');
        card.className = 'result-pot ' + (hasCoverage ? 'covered' : 'missing');
        var itemsHtml = pot.items.map(function(item) {
            var winners = getTopN(item.id, pot.winnersPerItem);
            var myBid = bids[item.id] || 0;
            if (myBid > 0 && winners.indexOf(teamName) >= 0) {
                return '<div class="result-item won"><span>' + item.id + ': ' + item.name + '</span><span class="badge">\u2705 WON</span></div>';
            } else if (myBid > 0) {
                return '<div class="result-item lost"><span>' + item.id + ': ' + item.name + '</span><span class="badge">\u274C LOST</span></div>';
            } else {
                return '<div class="result-item no-bid"><span>' + item.id + ': ' + item.name + '</span><span class="badge">No bid</span></div>';
            }
        }).join('');

        card.innerHTML =
            '<div class="result-pot-header">' +
            '<h3>' + pot.name + '</h3>' +
            '<span class="coverage-badge">' + (hasCoverage ? '\u2713 Covered' : '\u2717 Gap') + '</span>' +
            '</div>' +
            '<div class="result-items">' + itemsHtml + '</div>';
        grid.appendChild(card);
    });
}

// =============================================
// POLL BIDS
// =============================================

function pollAndSync() {
    var script = document.createElement('script');
    var cb = 'cb_' + Date.now();
    window[cb] = function(data) {
        if (data && data.bids) {
            allBids = data.bids;
            // Load this team's existing bids into local state
            POTS.forEach(function(pot) {
                pot.items.forEach(function(item) {
                    if (allBids[item.id] && allBids[item.id][teamName]) {
                        var existing = allBids[item.id][teamName];
                        if (existing > 0) {
                            bids[item.id] = existing;
                            var inp = document.getElementById('bid-' + item.id);
                            if (inp) { inp.value = existing; inp.classList.add('has-value'); }
                        }
                    }
                });
            });
            updateStats();
            updateAllStatuses();
            setStatus(true);
        }
        delete window[cb];
        script.remove();
    };
    script.src = API + '?action=getAllBids&callback=' + cb;
    script.onerror = function() { setStatus(false); script.remove(); delete window[cb]; };
    document.body.appendChild(script);
}

function poll() {
    var script = document.createElement('script');
    var cb = 'cb_' + Date.now();
    window[cb] = function(data) {
        if (data && data.bids) {
            allBids = data.bids;
            if (!frozen) {
                POTS.forEach(function(pot) {
                    pot.items.forEach(function(item) {
                        var serverBid = (allBids[item.id] && allBids[item.id][teamName]) || 0;
                        var localBid = bids[item.id] || 0;
                        var inp = document.getElementById('bid-' + item.id);
                        if (serverBid !== localBid && inp && document.activeElement !== inp) {
                            if (serverBid > 0) {
                                bids[item.id] = serverBid;
                                inp.value = serverBid;
                                inp.classList.add('has-value');
                            } else if (localBid === 0) {
                                delete bids[item.id];
                                inp.value = '';
                                inp.classList.remove('has-value');
                            }
                        }
                    });
                });
                updateStats();
            }
            updateAllStatuses();
            setStatus(true);
        }
        delete window[cb];
        script.remove();
    };
    script.src = API + '?action=getAllBids&callback=' + cb;
    script.onerror = function() { setStatus(false); script.remove(); delete window[cb]; };
    document.body.appendChild(script);
}

function setStatus(ok) {
    var el = document.getElementById('status');
    if (el) {
        el.textContent = ok ? 'Connected' : 'Offline';
        el.className = 'status ' + (ok ? 'ok' : 'err');
    }
}

// =============================================
// KEYBOARD NAV
// =============================================

document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && e.target.classList.contains('bid-input')) {
        var inputs = Array.from(document.querySelectorAll('.bid-input'));
        var idx = inputs.indexOf(e.target);
        if (idx < inputs.length - 1) inputs[idx + 1].focus();
    }
});

// =============================================
// INIT ‚Äî start polling state immediately (even before login)
// =============================================

// Poll state right away so we know if auction is already running
pollState();

// Poll state every 2 seconds, bids every 3 seconds (if joined)
setInterval(pollState, 2000);
setInterval(function() {
    if (hasJoined && auctionState !== 'waiting') poll();
}, 3000);

// Update timer display every second
setInterval(updateTimerDisplay, 1000);
</script>
</body>
</html>
