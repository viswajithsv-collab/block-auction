<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Block Diagram Auction ‚Äî Studio 1</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #1a1a3e 50%, #24243e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }
        .header {
            background: rgba(0,0,0,0.4);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e94560;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        .header h1 { color: #e94560; font-size: 1.4em; }
        .header-info { display: flex; gap: 20px; align-items: center; }
        .team-badge {
            background: #e94560;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }
        .budget-display { font-size: 1.1em; }
        .budget-display .amount { font-weight: bold; font-size: 1.3em; }
        .budget-display .amount.ok { color: #4ecca3; }
        .budget-display .amount.warn { color: #ffc107; }
        .budget-display .amount.over { color: #ff4444; }
        .timer {
            background: #e94560;
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 1.3em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            min-width: 80px;
            text-align: center;
        }
        .timer.warning { animation: pulse 1s infinite; }
        .timer.expired { background: #666; }
        @keyframes pulse { 0%,100% { background: #e94560; } 50% { background: #ff2244; } }

        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
            gap: 20px;
        }
        .login-screen h1 { color: #e94560; font-size: 2.2em; margin-bottom: 10px; }
        .login-screen p { color: #aaa; margin-bottom: 20px; font-size: 1.1em; }
        .login-screen input {
            padding: 14px 28px;
            font-size: 1.1em;
            border: 2px solid #444;
            border-radius: 10px;
            width: 320px;
            text-align: center;
            background: rgba(255,255,255,0.05);
            color: #fff;
            outline: none;
        }
        .login-screen input:focus { border-color: #e94560; }
        .login-screen input::placeholder { color: #666; }
        .login-screen button {
            padding: 14px 50px;
            font-size: 1.1em;
            background: #e94560;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .login-screen button:hover { background: #d63050; }

        .main-content { display: none; padding: 16px; padding-bottom: 120px; }
        .main-content.active { display: block; }

        .pots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 16px;
        }
        .pot-card {
            background: rgba(255,255,255,0.04);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.08);
            transition: border-color 0.3s;
        }
        .pot-card.has-bids { border-color: rgba(78, 204, 163, 0.3); }
        .pot-header {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .pot-header h3 { color: #e94560; font-size: 1em; }
        .pot-meta {
            display: flex;
            gap: 10px;
            font-size: 0.75em;
            color: #888;
        }
        .pot-meta .winners-badge {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
        }
        .pot-items { padding: 8px; }

        .item-row {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            margin: 4px 0;
            background: rgba(0,0,0,0.25);
            border-radius: 8px;
            border: 1px solid transparent;
            gap: 10px;
            transition: all 0.2s;
        }
        .item-row:hover { border-color: rgba(255,255,255,0.15); }
        .item-row.has-bid { border-color: rgba(78, 204, 163, 0.4); background: rgba(78, 204, 163, 0.06); }
        .item-id {
            font-family: 'Courier New', monospace;
            font-size: 0.75em;
            color: #888;
            min-width: 26px;
        }
        .item-info { flex: 1; min-width: 0; }
        .item-name {
            font-size: 0.9em;
            font-weight: 600;
            color: #ddd;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .item-desc {
            font-size: 0.72em;
            color: #777;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .bid-input {
            width: 56px;
            padding: 6px 4px;
            text-align: center;
            border: 1px solid #444;
            border-radius: 6px;
            background: rgba(0,0,0,0.4);
            color: #fff;
            font-size: 0.95em;
            font-weight: bold;
            outline: none;
        }
        .bid-input:focus { border-color: #4ecca3; }
        .bid-input.has-value { border-color: #4ecca3; background: rgba(78, 204, 163, 0.1); }

        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 12, 41, 0.95);
            backdrop-filter: blur(10px);
            border-top: 2px solid #e94560;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
        .bottom-bar .stats {
            display: flex;
            gap: 24px;
            font-size: 0.9em;
        }
        .bottom-bar .stats span { color: #888; }
        .bottom-bar .stats strong { color: #4ecca3; }
        .submit-btn {
            padding: 10px 40px;
            font-size: 1.1em;
            background: #4ecca3;
            color: #111;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        .submit-btn:hover { background: #3dbb92; }
        .submit-btn:disabled { background: #555; color: #888; cursor: not-allowed; }
        .submit-btn.submitted { background: #666; }

        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.9em;
            z-index: 300;
            animation: slideIn 0.3s ease;
        }
        .toast.success { background: #4ecca3; color: #111; }
        .toast.error { background: #ff4444; color: #fff; }
        .toast.info { background: #3498db; color: #fff; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        @media (max-width: 800px) {
            .pots-grid { grid-template-columns: 1fr; }
            .header { flex-wrap: wrap; gap: 8px; }
            .header h1 { font-size: 1.1em; }
        }
    </style>
</head>
<body>

<div class="login-screen" id="loginScreen">
    <h1>üèè Block Diagram Auction</h1>
    <p>Studio 1 ‚Äî Crayfish Axon Core Conductor Model</p>
    <input type="text" id="teamNameInput" placeholder="Enter your team name" autofocus>
    <button onclick="joinAuction()">Join Auction</button>
</div>

<div class="main-content" id="mainContent">
    <div class="header">
        <h1>üèè Block Diagram Auction</h1>
        <div class="header-info">
            <div class="team-badge" id="teamBadge"></div>
            <div class="budget-display">
                Budget: <span class="amount ok" id="budgetDisplay">100</span> / 100
            </div>
            <div class="timer" id="timer">15:00</div>
        </div>
    </div>
    <div class="pots-grid" id="potsGrid"></div>
    <div class="bottom-bar">
        <div class="stats">
            <span>Items bid on: <strong id="itemCount">0</strong> / <span id="totalItems">51</span></span>
            <span>Pots covered: <strong id="potsCovered">0</strong> / 8</span>
            <span>Points used: <strong id="pointsUsed">0</strong> / 100</span>
        </div>
        <button class="submit-btn" id="submitBtn" onclick="submitBids()">Submit Bids</button>
    </div>
</div>

<script>
// ============================================
// HARDCODED CONFIG
// ============================================
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzkDs0CuxWXFru1w_AjoJ8r5TvyUNw4MSO50BwlSHDURR5Qv66_MDQXa_T2fU1RnBs/exec';
const BUDGET = 100;
const TIMER_MINUTES = 15;

// ============================================
// AUCTION DATA
// ============================================
const AUCTION_POTS = [
  { id:"pot1", name:"Pot 1: Geometry", winnersPerItem:2, items:[
    {id:"G1",name:"a (axon radius)",desc:"Intracellular cross-section dimension"},
    {id:"G2",name:"b (extracellular boundary)",desc:"Extracellular cross-section dimension"},
    {id:"G3",name:"œÅ·µ¢ (cytoplasm resistivity)",desc:"Material property of intracellular medium"},
    {id:"G4",name:"œÅ‚Çí (extracellular resistivity)",desc:"Material property of extracellular medium"},
    {id:"G5",name:"r·µ¢ = œÅ·µ¢ / œÄa¬≤",desc:"Formula: geometry ‚Üí r·µ¢"},
    {id:"G6",name:"r‚Çí = œÅ‚Çí / œÄ(b¬≤‚àía¬≤)",desc:"Formula: geometry ‚Üí r‚Çí"},
    {id:"G7",name:"Micrometer + histology ‚Üí a, b",desc:"Method: measure radii from tissue"},
    {id:"G8",name:"Impedance ‚Üí r·µ¢, r‚Çí directly",desc:"Method: bypasses geometry"},
  ]},
  { id:"pot2", name:"Pot 2: Resting Membrane", winnersPerItem:3, items:[
    {id:"R1",name:"g_leak (leak conductance)",desc:"How leaky the membrane is"},
    {id:"R2",name:"E_rest (resting potential)",desc:"Equilibrium voltage"},
    {id:"R3",name:"K_leak = g_leak(V‚Çò ‚àí E_rest)",desc:"Leak current formula"},
    {id:"R4",name:"At rest: V‚Çò=E_rest ‚Üí K_leak=0",desc:"Equilibrium condition"},
    {id:"R5",name:"Current clamp ‚Üí R‚Çò",desc:"Method: inject I, measure ŒîV‚Çò"},
    {id:"R6",name:"Voltage clamp ‚Üí g_leak",desc:"Method: command V‚Çò, measure I‚Çò"},
  ]},
  { id:"pot3", name:"Pot 3: Synapse", winnersPerItem:3, items:[
    {id:"S1",name:"g_syn(t) (synaptic conductance)",desc:"Synapse on/off switch"},
    {id:"S2",name:"E_syn (reversal potential)",desc:"Where driving force = 0"},
    {id:"S3",name:"K_syn = g_syn(t)¬∑(V‚Çò ‚àí E_syn)",desc:"Synaptic current formula"},
    {id:"S4",name:"g_syn(t) is transient",desc:"Rises then falls"},
    {id:"S5",name:"Reversal potential expt ‚Üí E_syn",desc:"Method: vary V‚Çò, find I_syn=0"},
    {id:"S6",name:"Paired recording ‚Üí g_syn(t)",desc:"Method: stim pre, record post"},
  ]},
  { id:"pot4", name:"Pot 4: EPSP vs IPSP", winnersPerItem:2, items:[
    {id:"E1",name:"E_syn(EPSP) > E_rest",desc:"Reversal above rest"},
    {id:"E2",name:"E_syn(IPSP) < E_rest",desc:"Reversal below rest"},
    {id:"E3",name:"EPSP: (V‚Çò‚àíE_syn) < 0",desc:"Negative driving force"},
    {id:"E4",name:"IPSP: (V‚Çò‚àíE_syn) > 0",desc:"Positive driving force"},
    {id:"E5",name:"EPSP: K_syn<0 ‚Üí inward ‚Üí sink",desc:"Current into cell"},
    {id:"E6",name:"IPSP: K_syn>0 ‚Üí outward ‚Üí source",desc:"Current out of cell"},
    {id:"E7",name:"EPSP channels: cation (Na‚Å∫/K‚Å∫)",desc:"Excitatory ion mechanism"},
    {id:"E8",name:"IPSP channels: Cl‚Åª (GABA)",desc:"Inhibitory ion mechanism"},
  ]},
  { id:"pot5", name:"Pot 5: Ohm's Law", winnersPerItem:2, items:[
    {id:"O1",name:"I·µ¢ (intracellular current)",desc:"Current inside axon"},
    {id:"O2",name:"I‚Çí (extracellular current)",desc:"Current outside axon"},
    {id:"O3",name:"V·µ¢ (intracellular potential)",desc:"Voltage inside"},
    {id:"O4",name:"V‚Çí (extracellular potential)",desc:"Voltage outside"},
    {id:"O5",name:"‚àÇV·µ¢/‚àÇz = ‚àír·µ¢I·µ¢",desc:"Ohm's law intracellular"},
    {id:"O6",name:"‚àÇV‚Çí/‚àÇz = ‚àír‚ÇíI‚Çí",desc:"Ohm's law extracellular"},
    {id:"O7",name:"Current injection method",desc:"Pass known I, measure ŒîV"},
    {id:"O8",name:"Voltage gradient method",desc:"Measure V at two z positions"},
  ]},
  { id:"pot6", name:"Pot 6: KCL / Conservation", winnersPerItem:4, items:[
    {id:"K1",name:"‚àÇI·µ¢/‚àÇz = ‚àíK‚Çò",desc:"Intracellular current continuity"},
    {id:"K2",name:"‚àÇI‚Çí/‚àÇz = K‚Çò",desc:"Extracellular current continuity"},
    {id:"K3",name:"K‚Çò = K_leak + K_syn",desc:"Total membrane current"},
    {id:"K4",name:"Sink: K‚Çò<0 ‚Üí into cell",desc:"Inward current meaning"},
    {id:"K5",name:"Source: K‚Çò>0 ‚Üí out of cell",desc:"Outward current meaning"},
  ]},
  { id:"pot7", name:"Pot 7: Membrane Potential", winnersPerItem:4, items:[
    {id:"M1",name:"V‚Çò = V·µ¢ ‚àí V‚Çí",desc:"Membrane potential definition"},
    {id:"M2",name:"V·µ¢ = V‚Çò + V‚Çí",desc:"What intracellular electrode measures"},
    {id:"M3",name:"Differential recording ‚Üí V‚Çò",desc:"Method: simultaneous V·µ¢ and V‚Çí"},
    {id:"M4",name:"V·µ¢ ‚âà V‚Çò when r‚Çí ‚â™ r·µ¢",desc:"Approximation & when it breaks"},
  ]},
  { id:"pot8", name:"Pot 8: Electrodes & Recording", winnersPerItem:3, items:[
    {id:"L1",name:"Intracellular electrode ‚Üí V·µ¢",desc:"Inside electrode"},
    {id:"L2",name:"Extracellular electrode ‚Üí V‚Çí",desc:"Outside electrode"},
    {id:"L3",name:"r‚Çí > 0 required for V‚Çí",desc:"No signal if r‚Çí = 0"},
    {id:"L4",name:"EPSP: V·µ¢‚Üë, V‚Çí‚Üì",desc:"Opposite polarity (excitation)"},
    {id:"L5",name:"IPSP: V·µ¢‚Üì, V‚Çí‚Üë",desc:"Opposite polarity (inhibition)"},
    {id:"L6",name:"|ŒîV‚Çí| ‚àù r‚Çí",desc:"Larger r‚Çí = larger signal"},
  ]}
];

// ============================================
// STATE
// ============================================
let teamName = '';
let bids = {};
let timerInterval = null;
let timeRemaining = TIMER_MINUTES * 60;
let submitted = false;

// ============================================
// LOGIN
// ============================================
function joinAuction() {
    const name = document.getElementById('teamNameInput').value.trim();
    if (!name) { showToast('Enter a team name', 'error'); return; }
    teamName = name;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainContent').classList.add('active');
    document.getElementById('teamBadge').textContent = teamName;
    renderPots();
    startTimer();
}

document.getElementById('teamNameInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') joinAuction();
});

// ============================================
// RENDER
// ============================================
function renderPots() {
    const grid = document.getElementById('potsGrid');
    grid.innerHTML = '';
    AUCTION_POTS.forEach(pot => {
        const card = document.createElement('div');
        card.className = 'pot-card';
        card.id = `card-${pot.id}`;
        const winnersLabel = pot.winnersPerItem === 2 ? 'Top 2' :
                             pot.winnersPerItem === 3 ? 'Top 3' : 'Top 4';
        card.innerHTML = `
            <div class="pot-header">
                <h3>${pot.name}</h3>
                <div class="pot-meta">
                    <span>${pot.items.length} items</span>
                    <span class="winners-badge">${winnersLabel} win</span>
                </div>
            </div>
            <div class="pot-items">
                ${pot.items.map(item => `
                    <div class="item-row" id="row-${item.id}">
                        <span class="item-id">${item.id}</span>
                        <div class="item-info">
                            <div class="item-name">${item.name}</div>
                            <div class="item-desc">${item.desc}</div>
                        </div>
                        <input type="number" class="bid-input" id="bid-${item.id}"
                            min="0" max="100" placeholder="0"
                            data-item="${item.id}" data-pot="${pot.id}"
                            onchange="updateBid(this)" oninput="updateBid(this)">
                    </div>
                `).join('')}
            </div>
        `;
        grid.appendChild(card);
    });
    document.getElementById('totalItems').textContent =
        AUCTION_POTS.reduce((s, p) => s + p.items.length, 0);
}

// ============================================
// BID MANAGEMENT
// ============================================
function updateBid(input) {
    const itemId = input.dataset.item;
    const val = parseInt(input.value) || 0;
    const row = document.getElementById(`row-${itemId}`);
    if (val > 0) {
        bids[itemId] = val;
        input.classList.add('has-value');
        row.classList.add('has-bid');
    } else {
        delete bids[itemId];
        input.classList.remove('has-value');
        row.classList.remove('has-bid');
    }
    updateStats();
}

function updateStats() {
    const totalSpent = Object.values(bids).reduce((s, v) => s + v, 0);
    const itemsBidOn = Object.keys(bids).length;
    const potsCovered = new Set();
    AUCTION_POTS.forEach(pot => {
        pot.items.forEach(item => {
            if (bids[item.id]) potsCovered.add(pot.id);
        });
    });

    document.getElementById('pointsUsed').textContent = totalSpent;
    document.getElementById('itemCount').textContent = itemsBidOn;
    document.getElementById('potsCovered').textContent = potsCovered.size;

    const budgetEl = document.getElementById('budgetDisplay');
    const remaining = BUDGET - totalSpent;
    budgetEl.textContent = remaining;
    budgetEl.className = 'amount ' + (remaining < 0 ? 'over' : remaining < 15 ? 'warn' : 'ok');

    AUCTION_POTS.forEach(pot => {
        const card = document.getElementById(`card-${pot.id}`);
        const hasBids = pot.items.some(item => bids[item.id]);
        card.classList.toggle('has-bids', hasBids);
    });

    const btn = document.getElementById('submitBtn');
    if (submitted) {
        btn.textContent = '‚úì Submitted';
        btn.disabled = true;
        btn.classList.add('submitted');
    } else if (totalSpent > BUDGET) {
        btn.textContent = `Over budget by ${totalSpent - BUDGET}`;
        btn.disabled = true;
    } else if (totalSpent === 0) {
        btn.textContent = 'No bids placed';
        btn.disabled = true;
    } else {
        btn.textContent = `Submit Bids (${totalSpent} pts)`;
        btn.disabled = false;
    }
}

// ============================================
// TIMER
// ============================================
function startTimer() {
    updateTimerDisplay();
    timerInterval = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();
        if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            if (!submitted) submitBids(true);
        }
    }, 1000);
}

function updateTimerDisplay() {
    const el = document.getElementById('timer');
    const min = Math.floor(Math.max(0, timeRemaining) / 60);
    const sec = Math.max(0, timeRemaining) % 60;
    el.textContent = `${min}:${sec.toString().padStart(2, '0')}`;
    if (timeRemaining <= 0) {
        el.classList.add('expired');
        el.classList.remove('warning');
        el.textContent = "CLOSED";
    } else if (timeRemaining <= 120) {
        el.classList.add('warning');
    }
}

// ============================================
// SUBMIT
// ============================================
async function submitBids(auto = false) {
    if (submitted) return;
    const totalSpent = Object.values(bids).reduce((s, v) => s + v, 0);
    if (totalSpent > BUDGET) {
        showToast('Over budget! Remove some bids first.', 'error');
        return;
    }
    if (totalSpent === 0 && !auto) {
        showToast('Place at least one bid.', 'error');
        return;
    }

    submitted = true;
    updateStats();

    const payload = {
        action: 'submitBids',
        team: teamName,
        bids: bids,
        timestamp: new Date().toISOString()
    };

    try {
        showToast('Submitting...', 'info');
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        showToast('Bids submitted!', 'success');
    } catch (err) {
        showToast('Bids saved locally (network issue)', 'info');
        console.error('Submit error:', err);
    }

    localStorage.setItem(`auction_${teamName}`, JSON.stringify(payload));
    document.querySelectorAll('.bid-input').forEach(input => input.disabled = true);
}

// ============================================
// TOAST
// ============================================
function showToast(msg, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

document.addEventListener('keydown', e => {
    if (e.key === 'Enter' && e.target.classList.contains('bid-input')) {
        const inputs = [...document.querySelectorAll('.bid-input')];
        const idx = inputs.indexOf(e.target);
        if (idx < inputs.length - 1) inputs[idx + 1].focus();
    }
});
</script>
</body>
</html>
