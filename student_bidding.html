<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Block Diagram Auction</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }
        .header {
            background: rgba(0,0,0,0.3);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e94560;
        }
        .header h1 { color: #e94560; font-size: 1.8em; }
        .header-info { display: flex; gap: 30px; align-items: center; }
        .team-name { background: #e94560; padding: 8px 20px; border-radius: 20px; font-weight: bold; }
        .budget-display { font-size: 1.4em; }
        .budget-display span { color: #4ecca3; font-weight: bold; }
        .timer {
            background: #e94560;
            padding: 10px 25px;
            border-radius: 10px;
            font-size: 1.5em;
            font-weight: bold;
            font-family: monospace;
        }
        .timer.warning { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { background: #e94560; } 50% { background: #ff6b6b; } }
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
            gap: 20px;
        }
        .login-screen h1 { color: #e94560; font-size: 2.5em; margin-bottom: 20px; }
        .login-screen input {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            width: 300px;
            text-align: center;
        }
        .login-screen button {
            padding: 15px 50px;
            font-size: 1.2em;
            background: #e94560;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }
        .main-content { display: none; padding: 20px; padding-bottom: 100px; }
        .main-content.active { display: block; }
        .sets-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        .set-card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .set-header {
            background: rgba(233, 69, 96, 0.3);
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .set-header h3 { color: #e94560; margin-bottom: 5px; }
        .set-header p { color: #aaa; font-size: 0.9em; }
        .set-items { padding: 10px; }
        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            border: 1px solid transparent;
            transition: all 0.3s;
        }
        .item:hover { border-color: #4ecca3; }
        .item.has-bid { border-color: #4ecca3; background: rgba(78, 204, 163, 0.1); }
        .item.outbid { border-color: #ff6b6b; background: rgba(255, 107, 107, 0.1); }
        .item.winning { border-color: #4ecca3; background: rgba(78, 204, 163, 0.2); box-shadow: 0 0 10px rgba(78, 204, 163, 0.3); }
        .item-info { flex: 1; }
        .item-name { font-weight: bold; color: #fff; font-size: 1.1em; }
        .item-desc { color: #888; font-size: 0.85em; margin-top: 3px; }
        .item-bidding { display: flex; align-items: center; gap: 10px; }
        .current-high { text-align: right; min-width: 80px; }
        .current-high .label { font-size: 0.7em; color: #888; }
        .current-high .value { font-weight: bold; color: #4ecca3; }
        .current-high .leader { font-size: 0.7em; color: #e94560; }
        .bid-input {
            width: 70px;
            padding: 8px;
            border: 2px solid #4ecca3;
            border-radius: 8px;
            background: rgba(0,0,0,0.5);
            color: #fff;
            text-align: center;
            font-size: 1em;
            font-weight: bold;
        }
        .bid-input:focus { outline: none; border-color: #e94560; }
        .submit-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.9);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 2px solid #e94560;
        }
        .budget-bar { flex: 1; margin: 0 30px; }
        .budget-bar-inner { height: 20px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; }
        .budget-bar-fill { height: 100%; background: linear-gradient(90deg, #4ecca3, #e94560); transition: width 0.3s; }
        .budget-text { text-align: center; margin-top: 5px; font-size: 0.9em; }
        .submit-btn {
            padding: 15px 40px;
            font-size: 1.2em;
            background: #4ecca3;
            color: #1a1a2e;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }
        .submit-btn:disabled { background: #666; cursor: not-allowed; }
        .status { padding: 5px 15px; border-radius: 15px; font-size: 0.8em; }
        .status.ok { background: #4ecca3; color: #1a1a2e; }
        .status.err { background: #e94560; }
        .frozen .bid-input { pointer-events: none; opacity: 0.5; }
        .frozen-banner {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #e94560;
            padding: 30px 60px;
            border-radius: 20px;
            font-size: 2em;
            font-weight: bold;
            z-index: 1000;
        }
        .frozen .frozen-banner { display: block; }
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <h1>üéØ Block Diagram Auction</h1>
        <p style="color: #aaa; margin-bottom: 20px;">Crayfish Axon EPSP/IPSP Model</p>
        <input type="text" id="teamNameInput" placeholder="Enter Team Name">
        <button onclick="joinAuction()">Join Auction</button>
    </div>

    <div class="main-content" id="mainContent">
        <div class="header">
            <h1>üéØ Block Diagram Auction</h1>
            <div class="header-info">
                <div class="team-name" id="teamDisplay">Team</div>
                <div class="budget-display">Budget: <span id="remainingBudget">100</span>/100</div>
                <div class="timer" id="timer">15:00</div>
                <div class="status err" id="status">Connecting...</div>
            </div>
        </div>
        <div class="sets-container" id="setsContainer"></div>
        <div class="submit-section">
            <div style="color: #888;">Allocated:</div>
            <div class="budget-bar">
                <div class="budget-bar-inner">
                    <div class="budget-bar-fill" id="budgetBar" style="width: 0%"></div>
                </div>
                <div class="budget-text"><span id="allocatedPoints">0</span> / 100 points</div>
            </div>
            <button class="submit-btn" id="submitBtn" onclick="submitBids()">Update Bids</button>
        </div>
        <div class="frozen-banner">‚è±Ô∏è AUCTION FROZEN!</div>
    </div>

<script>
const BUDGET = 100;
const DURATION = 15 * 60;
const API = 'https://script.google.com/macros/s/AKfycbwbMIZyLuPD4kIDN0XJXfr4B1UDCcPwUkEtQon2lLWHqXUOpIzBgh4kFDxI9PFkrzM/exec';

const SETS = [
    { id: "set1", name: "Set 1: Geometry", description: "Physical structure of the axon", items: [
        { id: "a", name: "a", description: "Axon radius" },
        { id: "b", name: "b", description: "Extracellular boundary radius" },
        { id: "ri_eq", name: "r<sub>i</sub> = œÅ<sub>i</sub>/œÄa¬≤", description: "Intracellular resistance per unit length" },
        { id: "ro_eq", name: "r<sub>o</sub> = œÅ<sub>o</sub>/œÄ(b¬≤‚àía¬≤)", description: "Extracellular resistance per unit length" }
    ]},
    { id: "set2", name: "Set 2: Passive Membrane", description: "Resting membrane properties", items: [
        { id: "gleak", name: "g<sub>leak</sub>", description: "Leak conductance per unit length" },
        { id: "Erest", name: "E<sub>rest</sub>", description: "Resting membrane potential" },
        { id: "Kleak", name: "K<sub>leak</sub> = g<sub>leak</sub>(V<sub>m</sub> ‚àí E<sub>rest</sub>)", description: "Leak current" }
    ]},
    { id: "set3", name: "Set 3: Synaptic Input", description: "Synapse properties", items: [
        { id: "gsyn", name: "g<sub>syn</sub>(t)", description: "Synaptic conductance" },
        { id: "Esyn", name: "E<sub>syn</sub>", description: "Synaptic reversal potential" },
        { id: "Ksyn", name: "K<sub>syn</sub> = g<sub>syn</sub>(V<sub>m</sub> ‚àí E<sub>syn</sub>)", description: "Synaptic current" }
    ]},
    { id: "set4", name: "Set 4: Ion Reversal Potentials", description: "Nernst potentials", items: [
        { id: "ENa", name: "E<sub>Na</sub>", description: "Sodium reversal potential" },
        { id: "EK", name: "E<sub>K</sub>", description: "Potassium reversal potential" },
        { id: "ECl", name: "E<sub>Cl</sub>", description: "Chloride reversal potential" }
    ]},
    { id: "set5", name: "Set 5: EPSP Specification", description: "What makes an EPSP", items: [
        { id: "Esyn_epsp", name: "E<sub>syn</sub> > E<sub>rest</sub>", description: "EPSP reversal constraint" },
        { id: "df_epsp", name: "(V<sub>m</sub> ‚àí E<sub>syn</sub>) < 0", description: "Driving force negative" },
        { id: "Ksyn_epsp", name: "K<sub>syn</sub> < 0 (inward)", description: "Current inward (sink)" }
    ]},
    { id: "set6", name: "Set 6: IPSP Specification", description: "What makes an IPSP", items: [
        { id: "Esyn_ipsp", name: "E<sub>syn</sub> < E<sub>rest</sub>", description: "IPSP reversal constraint" },
        { id: "df_ipsp", name: "(V<sub>m</sub> ‚àí E<sub>syn</sub>) > 0", description: "Driving force positive" },
        { id: "Ksyn_ipsp", name: "K<sub>syn</sub> > 0 (outward)", description: "Current outward (source)" }
    ]},
    { id: "set7", name: "Set 7: Total Membrane Current", description: "Combining currents", items: [
        { id: "Km_total", name: "K<sub>m</sub> = K<sub>leak</sub> + K<sub>syn</sub>", description: "Total membrane current" },
        { id: "z0", name: "z<sub>0</sub>", description: "Synapse location" }
    ]},
    { id: "set8", name: "Set 8: Intracellular Domain", description: "Inside the axon", items: [
        { id: "Ii", name: "I<sub>i</sub>", description: "Intracellular current" },
        { id: "Vi", name: "V<sub>i</sub>", description: "Intracellular potential" },
        { id: "dVi", name: "‚àÇV<sub>i</sub>/‚àÇz = ‚àír<sub>i</sub>I<sub>i</sub>", description: "Ohm's law inside" }
    ]},
    { id: "set9", name: "Set 9: Extracellular Domain", description: "Outside the axon", items: [
        { id: "Io", name: "I<sub>o</sub>", description: "Extracellular current" },
        { id: "Vo", name: "V<sub>o</sub>", description: "Extracellular potential" },
        { id: "dVo", name: "‚àÇV<sub>o</sub>/‚àÇz = ‚àír<sub>o</sub>I<sub>o</sub>", description: "Ohm's law outside" }
    ]},
    { id: "set10", name: "Set 10: Current Conservation", description: "KCL constraints", items: [
        { id: "dIi", name: "‚àÇI<sub>i</sub>/‚àÇz = ‚àíK<sub>m</sub>", description: "Intracellular continuity" },
        { id: "dIo", name: "‚àÇI<sub>o</sub>/‚àÇz = K<sub>m</sub>", description: "Extracellular continuity" }
    ]},
    { id: "set11", name: "Set 11: Membrane Potential", description: "Voltage relationships", items: [
        { id: "Vm_def", name: "V<sub>m</sub> = V<sub>i</sub> ‚àí V<sub>o</sub>", description: "Membrane potential definition" },
        { id: "Vi_eq", name: "V<sub>i</sub> = V<sub>m</sub> + V<sub>o</sub>", description: "Intracellular relationship" }
    ]},
    { id: "set12", name: "Set 12: Governing Equation", description: "Core conductor equation", items: [
        { id: "gov_eq", name: "‚àÇ¬≤V<sub>m</sub>/‚àÇz¬≤ = (r<sub>o</sub>+r<sub>i</sub>)K<sub>m</sub>", description: "Combined equation" }
    ]},
    { id: "set13", name: "Set 13: Intracellular Recording", description: "What electrode sees", items: [
        { id: "intra_elec", name: "Intracellular electrode", description: "Measures V<sub>i</sub>" },
        { id: "epsp_intra", name: "EPSP: V<sub>i</sub> ‚Üë", description: "Depolarization" },
        { id: "ipsp_intra", name: "IPSP: V<sub>i</sub> ‚Üì", description: "Hyperpolarization" }
    ]},
    { id: "set14", name: "Set 14: Extracellular Recording", description: "What electrode sees", items: [
        { id: "extra_elec", name: "Extracellular electrode", description: "Measures V<sub>o</sub>" },
        { id: "epsp_extra", name: "EPSP: V<sub>o</sub> ‚Üì", description: "Negative (sink)" },
        { id: "ipsp_extra", name: "IPSP: V<sub>o</sub> ‚Üë", description: "Positive (source)" }
    ]},
    { id: "set15", name: "Set 15: Key Constraints", description: "Critical constraints", items: [
        { id: "ro_constraint", name: "r<sub>o</sub> > 0", description: "Required for extracellular signal" },
        { id: "gsyn_constraint", name: "g<sub>syn</sub> > 0", description: "Required for synaptic current" }
    ]},
    { id: "set16", name: "Set 16: Signal Polarity", description: "Key insight", items: [
        { id: "polarity", name: "ŒîV<sub>o</sub> opposite to ŒîV<sub>m</sub>", description: "Opposite polarity" },
        { id: "ro_magnitude", name: "|ŒîV<sub>o</sub>| depends on r<sub>o</sub>", description: "Larger r<sub>o</sub> = larger signal" }
    ]}
];

let teamName = '';
let bids = {};
let allBids = {};
let timeLeft = DURATION;

function joinAuction() {
    teamName = document.getElementById('teamNameInput').value.trim();
    if (!teamName) { alert('Enter team name'); return; }
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainContent').classList.add('active');
    document.getElementById('teamDisplay').textContent = teamName;
    renderSets();
    startTimer();
    poll();
    setInterval(poll, 3000);
}

function renderSets() {
    const c = document.getElementById('setsContainer');
    c.innerHTML = SETS.map(s => `
        <div class="set-card">
            <div class="set-header"><h3>${s.name}</h3><p>${s.description}</p></div>
            <div class="set-items">
                ${s.items.map(i => `
                    <div class="item" id="item-${i.id}">
                        <div class="item-info">
                            <div class="item-name">${i.name}</div>
                            <div class="item-desc">${i.description}</div>
                        </div>
                        <div class="item-bidding">
                            <div class="current-high">
                                <div class="label">High</div>
                                <div class="value" id="high-${i.id}">0</div>
                                <div class="leader" id="leader-${i.id}">-</div>
                            </div>
                            <input type="number" class="bid-input" id="bid-${i.id}" min="0" value="0" onchange="updateBid('${i.id}',this.value)" onfocus="this.select()">
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `).join('');
}

function updateBid(id, val) {
    bids[id] = parseInt(val) || 0;
    updateBudget();
    updateStatus(id);
}

function updateBudget() {
    const used = Object.values(bids).reduce((a,b) => a+b, 0);
    document.getElementById('remainingBudget').textContent = BUDGET - used;
    document.getElementById('allocatedPoints').textContent = used;
    document.getElementById('budgetBar').style.width = used + '%';
    document.getElementById('submitBtn').disabled = used > BUDGET;
    document.getElementById('remainingBudget').style.color = used > BUDGET ? '#ff6b6b' : '#4ecca3';
}

function updateStatus(id) {
    const el = document.getElementById('item-' + id);
    if (!el) return;
    const my = bids[id] || 0;
    const hi = getHigh(id);
    const lead = getLead(id);
    el.classList.remove('has-bid','winning','outbid');
    if (my > 0) {
        el.classList.add('has-bid');
        if (lead === teamName) el.classList.add('winning');
        else if (my <= hi) el.classList.add('outbid');
    }
}

function getHigh(id) {
    if (!allBids[id]) return 0;
    return Math.max(...Object.values(allBids[id]), 0);
}

function getLead(id) {
    if (!allBids[id]) return '-';
    let max = 0, lead = '-';
    for (const [t,b] of Object.entries(allBids[id])) {
        if (b > max) { max = b; lead = t; }
    }
    return lead;
}

function submitBids() {
    const btn = document.getElementById('submitBtn');
    btn.textContent = 'Saving...';
    
    // Create form and submit via hidden iframe
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = API;
    form.target = 'submitFrame';
    
    const addField = (name, val) => {
        const inp = document.createElement('input');
        inp.type = 'hidden';
        inp.name = name;
        inp.value = val;
        form.appendChild(inp);
    };
    
    addField('action', 'submitBids');
    addField('teamName', teamName);
    addField('bids', JSON.stringify(bids));
    
    // Create iframe if doesn't exist
    let iframe = document.getElementById('submitFrame');
    if (!iframe) {
        iframe = document.createElement('iframe');
        iframe.id = 'submitFrame';
        iframe.name = 'submitFrame';
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
    }
    
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
    
    setTimeout(() => {
        btn.textContent = 'Update Bids';
        poll(); // Refresh data
    }, 2000);
}

function poll() {
    // Use image ping + localStorage trick for cross-origin
    // Actually, let's try a simple approach: just fetch and handle error gracefully
    
    const img = new Image();
    const ts = Date.now();
    
    // We'll use the Google Apps Script with a callback parameter
    // But since we can't get the response, we'll just trigger it and rely on the sheet
    
    // For reading, we need to use a workaround
    // Let's try creating a script tag
    
    const script = document.createElement('script');
    const cb = 'cb_' + ts;
    
    window[cb] = function(data) {
        if (data && data.bids) {
            allBids = data.bids;
            refreshDisplay();
            setStatus(true);
        }
        delete window[cb];
    };
    
    script.src = API + '?action=getAllBids&callback=' + cb;
    script.onload = () => setTimeout(() => script.remove(), 100);
    script.onerror = () => {
        setStatus(false);
        script.remove();
        delete window[cb];
    };
    
    document.body.appendChild(script);
}

function refreshDisplay() {
    SETS.forEach(s => s.items.forEach(i => {
        const hEl = document.getElementById('high-' + i.id);
        const lEl = document.getElementById('leader-' + i.id);
        if (hEl) hEl.textContent = getHigh(i.id);
        if (lEl) lEl.textContent = getLead(i.id);
        updateStatus(i.id);
    }));
}

function setStatus(ok) {
    const el = document.getElementById('status');
    el.textContent = ok ? 'Connected' : 'Offline';
    el.className = 'status ' + (ok ? 'ok' : 'err');
}

function startTimer() {
    setInterval(() => {
        if (timeLeft <= 0) {
            document.getElementById('mainContent').classList.add('frozen');
            document.getElementById('timer').textContent = 'FROZEN';
            return;
        }
        timeLeft--;
        const m = Math.floor(timeLeft / 60);
        const s = timeLeft % 60;
        document.getElementById('timer').textContent = m.toString().padStart(2,'0') + ':' + s.toString().padStart(2,'0');
        if (timeLeft < 120) document.getElementById('timer').classList.add('warning');
    }, 1000);
}

document.addEventListener('keydown', e => {
    if (e.key === 'Enter' && document.getElementById('loginScreen').style.display !== 'none') joinAuction();
});
</script>
</body>
</html>
