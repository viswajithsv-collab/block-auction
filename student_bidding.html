<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Block Diagram Auction ‚Äî Studio 1</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 100%);
            min-height: 100vh;
            color: #fff;
        }
        .login-screen {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; height: 100vh; gap: 15px;
        }
        .login-screen h1 { color: #e94560; font-size: 2.2em; }
        .login-screen p { color: #aaa; margin-bottom: 10px; }
        .login-screen input {
            padding: 14px 28px; font-size: 1.1em; border: 2px solid #444;
            border-radius: 10px; width: 320px; text-align: center;
            background: rgba(255,255,255,0.05); color: #fff; outline: none;
        }
        .login-screen input:focus { border-color: #e94560; }
        .login-screen input::placeholder { color: #666; }
        .login-screen button {
            padding: 14px 50px; font-size: 1.1em; background: #e94560;
            color: white; border: none; border-radius: 10px; cursor: pointer;
        }
        .login-screen button:hover { background: #d63050; }
        .main-content { display: none; padding: 15px; padding-bottom: 100px; }
        .main-content.active { display: block; }
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; background: rgba(0,0,0,0.3); border-radius: 12px;
            margin-bottom: 15px; border: 1px solid #e94560;
        }
        .header h1 { color: #e94560; font-size: 1.3em; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .team-badge { background: #e94560; padding: 5px 14px; border-radius: 15px; font-weight: bold; font-size: 0.9em; }
        .timer-display {
            font-size: 1.8em; font-family: monospace; color: #4ecca3;
            background: rgba(0,0,0,0.5); padding: 6px 20px; border-radius: 8px;
        }
        .timer-display.warning { color: #e94560; animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
        .status { padding: 4px 12px; border-radius: 12px; font-size: 0.8em; }
        .status.ok { background: #4ecca3; color: #1a1a2e; }
        .status.err { background: #e94560; }

        .pots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 14px;
        }
        .pot-card {
            background: rgba(255,255,255,0.04); border-radius: 12px;
            overflow: hidden; border: 1px solid rgba(255,255,255,0.08);
        }
        .pot-header {
            padding: 10px 14px; background: rgba(0,0,0,0.2);
            display: flex; justify-content: space-between; align-items: center;
        }
        .pot-header h3 { color: #e94560; font-size: 0.95em; }
        .pot-meta { display: flex; gap: 8px; font-size: 0.72em; color: #888; }
        .winners-badge {
            background: rgba(233,69,96,0.2); color: #e94560;
            padding: 2px 7px; border-radius: 8px; font-weight: bold;
        }
        .pot-items { padding: 6px; }
        .item-row {
            display: flex; align-items: center; padding: 7px 10px; margin: 3px 0;
            background: rgba(0,0,0,0.25); border-radius: 7px;
            border: 1px solid transparent; gap: 8px; transition: all 0.2s;
        }
        .item-row.has-bid { border-color: rgba(78,204,163,0.4); background: rgba(78,204,163,0.06); }
        .item-row.winning { border-color: #4ecca3; }
        .item-row.outbid { border-color: rgba(233,69,96,0.4); background: rgba(233,69,96,0.06); }
        .item-id { font-family: monospace; font-size: 0.72em; color: #888; min-width: 24px; }
        .item-info { flex: 1; min-width: 0; }
        .item-name { font-size: 0.88em; font-weight: 600; color: #ddd; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-desc { font-size: 0.7em; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-status { font-size: 0.7em; color: #888; min-width: 55px; text-align: right; }
        .item-status .high { color: #e94560; font-weight: bold; }
        .bid-input {
            width: 52px; padding: 5px 3px; text-align: center;
            border: 1px solid #444; border-radius: 5px;
            background: rgba(0,0,0,0.4); color: #fff;
            font-size: 0.9em; font-weight: bold; outline: none;
        }
        .bid-input:focus { border-color: #4ecca3; }
        .bid-input.has-value { border-color: #4ecca3; background: rgba(78,204,163,0.1); }

        .submit-section {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.9); padding: 12px 24px;
            display: flex; justify-content: space-between; align-items: center;
            border-top: 2px solid #e94560; z-index: 100;
        }
        .budget-info { display: flex; gap: 20px; font-size: 0.9em; color: #888; }
        .budget-info strong { color: #4ecca3; }
        .budget-info strong.over { color: #ff4444; }
        .submit-btn {
            padding: 10px 35px; font-size: 1.1em; background: #4ecca3;
            color: #1a1a2e; border: none; border-radius: 8px;
            cursor: pointer; font-weight: bold;
        }
        .submit-btn:disabled { background: #666; cursor: not-allowed; color: #888; }
        .frozen .bid-input { pointer-events: none; opacity: 0.5; }
        .frozen-banner {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%,-50%); background: #e94560;
            padding: 30px 60px; border-radius: 20px; font-size: 2em;
            font-weight: bold; z-index: 1000;
        }
        .frozen .frozen-banner { display: block; }

        @media (max-width: 800px) { .pots-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <h1>üèè Block Diagram Auction</h1>
        <p>Studio 1 ‚Äî Crayfish Axon Core Conductor Model</p>
        <input type="text" id="teamNameInput" placeholder="Enter Team Name" autofocus>
        <button onclick="joinAuction()">Join Auction</button>
    </div>

    <div class="main-content" id="mainContent">
        <div class="header">
            <h1>üèè Block Diagram Auction</h1>
            <div class="header-right">
                <span class="team-badge" id="teamBadge"></span>
                <span class="status err" id="status">Connecting...</span>
                <div class="timer-display" id="timer">15:00</div>
            </div>
        </div>
        <div class="pots-grid" id="potsGrid"></div>
        <div class="submit-section">
            <div class="budget-info">
                <span>Points: <strong id="pointsUsed">0</strong> / 100</span>
                <span>Items: <strong id="itemCount">0</strong></span>
                <span>Pots: <strong id="potsCovered">0</strong> / 8</span>
            </div>
            <button class="submit-btn" id="submitBtn" onclick="submitBids()">Update Bids</button>
        </div>
        <div class="frozen-banner">‚è±Ô∏è AUCTION CLOSED!</div>
    </div>

<script>
const API = 'https://script.google.com/macros/s/AKfycbzkDs0CuxWXFru1w_AjoJ8r5TvyUNw4MSO50BwlSHDURR5Qv66_MDQXa_T2fU1RnBs/exec';
const BUDGET = 100;
const DURATION = 15 * 60;

const POTS = [
  { id:"pot1", name:"Pot 1: Geometry", winnersPerItem:2, items:[
    {id:"G1",name:"a (axon radius)",desc:"Intracellular cross-section dimension"},
    {id:"G2",name:"b (extracellular boundary)",desc:"Extracellular cross-section dimension"},
    {id:"G3",name:"œÅ·µ¢ (cytoplasm resistivity)",desc:"Material property of intracellular medium"},
    {id:"G4",name:"œÅ‚Çí (extracellular resistivity)",desc:"Material property of extracellular medium"},
    {id:"G5",name:"r·µ¢ = œÅ·µ¢ / œÄa¬≤",desc:"Formula: geometry ‚Üí r·µ¢"},
    {id:"G6",name:"r‚Çí = œÅ‚Çí / œÄ(b¬≤‚àía¬≤)",desc:"Formula: geometry ‚Üí r‚Çí"},
    {id:"G7",name:"Micrometer + histology ‚Üí a, b",desc:"Method: measure radii from tissue"},
    {id:"G8",name:"Impedance ‚Üí r·µ¢, r‚Çí directly",desc:"Method: bypasses geometry"},
  ]},
  { id:"pot2", name:"Pot 2: Resting Membrane", winnersPerItem:3, items:[
    {id:"R1",name:"g_leak (leak conductance)",desc:"How leaky the membrane is"},
    {id:"R2",name:"E_rest (resting potential)",desc:"Equilibrium voltage"},
    {id:"R3",name:"K_leak = g_leak(V‚Çò ‚àí E_rest)",desc:"Leak current formula"},
    {id:"R4",name:"At rest: V‚Çò=E_rest ‚Üí K_leak=0",desc:"Equilibrium condition"},
    {id:"R5",name:"Current clamp ‚Üí R‚Çò",desc:"Method: inject I, measure ŒîV‚Çò"},
    {id:"R6",name:"Voltage clamp ‚Üí g_leak",desc:"Method: command V‚Çò, measure I‚Çò"},
  ]},
  { id:"pot3", name:"Pot 3: Synapse", winnersPerItem:3, items:[
    {id:"S1",name:"g_syn(t) (synaptic conductance)",desc:"Synapse on/off switch"},
    {id:"S2",name:"E_syn (reversal potential)",desc:"Where driving force = 0"},
    {id:"S3",name:"K_syn = g_syn(t)¬∑(V‚Çò ‚àí E_syn)",desc:"Synaptic current formula"},
    {id:"S4",name:"g_syn(t) is transient",desc:"Rises then falls"},
    {id:"S5",name:"Reversal potential expt ‚Üí E_syn",desc:"Method: vary V‚Çò, find I_syn=0"},
    {id:"S6",name:"Paired recording ‚Üí g_syn(t)",desc:"Method: stim pre, record post"},
  ]},
  { id:"pot4", name:"Pot 4: EPSP vs IPSP", winnersPerItem:2, items:[
    {id:"E1",name:"E_syn(EPSP) > E_rest",desc:"Reversal above rest"},
    {id:"E2",name:"E_syn(IPSP) < E_rest",desc:"Reversal below rest"},
    {id:"E3",name:"EPSP: (V‚Çò‚àíE_syn) < 0",desc:"Negative driving force"},
    {id:"E4",name:"IPSP: (V‚Çò‚àíE_syn) > 0",desc:"Positive driving force"},
    {id:"E5",name:"EPSP: K_syn<0 ‚Üí inward ‚Üí sink",desc:"Current into cell"},
    {id:"E6",name:"IPSP: K_syn>0 ‚Üí outward ‚Üí source",desc:"Current out of cell"},
    {id:"E7",name:"EPSP channels: cation (Na‚Å∫/K‚Å∫)",desc:"Excitatory ion mechanism"},
    {id:"E8",name:"IPSP channels: Cl‚Åª (GABA)",desc:"Inhibitory ion mechanism"},
  ]},
  { id:"pot5", name:"Pot 5: Ohm's Law", winnersPerItem:2, items:[
    {id:"O1",name:"I·µ¢ (intracellular current)",desc:"Current inside axon"},
    {id:"O2",name:"I‚Çí (extracellular current)",desc:"Current outside axon"},
    {id:"O3",name:"V·µ¢ (intracellular potential)",desc:"Voltage inside"},
    {id:"O4",name:"V‚Çí (extracellular potential)",desc:"Voltage outside"},
    {id:"O5",name:"‚àÇV·µ¢/‚àÇz = ‚àír·µ¢I·µ¢",desc:"Ohm's law intracellular"},
    {id:"O6",name:"‚àÇV‚Çí/‚àÇz = ‚àír‚ÇíI‚Çí",desc:"Ohm's law extracellular"},
    {id:"O7",name:"Current injection method",desc:"Pass known I, measure ŒîV"},
    {id:"O8",name:"Voltage gradient method",desc:"Measure V at two z positions"},
  ]},
  { id:"pot6", name:"Pot 6: KCL / Conservation", winnersPerItem:4, items:[
    {id:"K1",name:"‚àÇI·µ¢/‚àÇz = ‚àíK‚Çò",desc:"Intracellular current continuity"},
    {id:"K2",name:"‚àÇI‚Çí/‚àÇz = K‚Çò",desc:"Extracellular current continuity"},
    {id:"K3",name:"K‚Çò = K_leak + K_syn",desc:"Total membrane current"},
    {id:"K4",name:"Sink: K‚Çò<0 ‚Üí into cell",desc:"Inward current meaning"},
    {id:"K5",name:"Source: K‚Çò>0 ‚Üí out of cell",desc:"Outward current meaning"},
  ]},
  { id:"pot7", name:"Pot 7: Membrane Potential", winnersPerItem:4, items:[
    {id:"M1",name:"V‚Çò = V·µ¢ ‚àí V‚Çí",desc:"Membrane potential definition"},
    {id:"M2",name:"V·µ¢ = V‚Çò + V‚Çí",desc:"What intracellular electrode measures"},
    {id:"M3",name:"Differential recording ‚Üí V‚Çò",desc:"Method: simultaneous V·µ¢ and V‚Çí"},
    {id:"M4",name:"V·µ¢ ‚âà V‚Çò when r‚Çí ‚â™ r·µ¢",desc:"Approximation & when it breaks"},
  ]},
  { id:"pot8", name:"Pot 8: Electrodes & Recording", winnersPerItem:3, items:[
    {id:"L1",name:"Intracellular electrode ‚Üí V·µ¢",desc:"Inside electrode"},
    {id:"L2",name:"Extracellular electrode ‚Üí V‚Çí",desc:"Outside electrode"},
    {id:"L3",name:"r‚Çí > 0 required for V‚Çí",desc:"No signal if r‚Çí = 0"},
    {id:"L4",name:"EPSP: V·µ¢‚Üë, V‚Çí‚Üì",desc:"Opposite polarity (excitation)"},
    {id:"L5",name:"IPSP: V·µ¢‚Üì, V‚Çí‚Üë",desc:"Opposite polarity (inhibition)"},
    {id:"L6",name:"|ŒîV‚Çí| ‚àù r‚Çí",desc:"Larger r‚Çí = larger signal"},
  ]}
];

let teamName = '';
let bids = {};
let allBids = {};   // { itemId: { team: amount } } ‚Äî from Sheets
let timeLeft = DURATION;
let timerInterval = null;

// --- LOGIN ---
function joinAuction() {
    const name = document.getElementById('teamNameInput').value.trim();
    if (!name) return;
    teamName = name;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainContent').classList.add('active');
    document.getElementById('teamBadge').textContent = teamName;
    renderPots();
    startTimer();
    poll();
    setInterval(poll, 2000);
}
document.getElementById('teamNameInput').addEventListener('keydown', e => { if (e.key === 'Enter') joinAuction(); });

// --- RENDER ---
function renderPots() {
    const grid = document.getElementById('potsGrid');
    grid.innerHTML = '';
    POTS.forEach(pot => {
        const wLabel = pot.winnersPerItem === 2 ? 'Top 2' : pot.winnersPerItem === 3 ? 'Top 3' : 'Top 4';
        const card = document.createElement('div');
        card.className = 'pot-card';
        card.innerHTML = `
            <div class="pot-header">
                <h3>${pot.name}</h3>
                <div class="pot-meta">
                    <span>${pot.items.length} items</span>
                    <span class="winners-badge">${wLabel} win</span>
                </div>
            </div>
            <div class="pot-items">
                ${pot.items.map(item => `
                    <div class="item-row" id="item-${item.id}">
                        <span class="item-id">${item.id}</span>
                        <div class="item-info">
                            <div class="item-name">${item.name}</div>
                            <div class="item-desc">${item.desc}</div>
                        </div>
                        <div class="item-status">
                            <span id="high-${item.id}">‚Äî</span>
                        </div>
                        <input type="number" class="bid-input" id="bid-${item.id}"
                            min="0" max="100" placeholder="0"
                            data-item="${item.id}"
                            onchange="updateBid(this)" oninput="updateBid(this)">
                    </div>
                `).join('')}
            </div>
        `;
        grid.appendChild(card);
    });
}

// --- BIDS ---
function updateBid(input) {
    const id = input.dataset.item;
    const val = parseInt(input.value) || 0;
    if (val > 0) { bids[id] = val; input.classList.add('has-value'); }
    else { delete bids[id]; input.classList.remove('has-value'); }
    updateStats();
    updateAllStatuses();
}

function updateStats() {
    const used = Object.values(bids).reduce((s,v) => s+v, 0);
    const count = Object.keys(bids).length;
    const pots = new Set();
    POTS.forEach(pot => pot.items.forEach(item => { if (bids[item.id]) pots.add(pot.id); }));

    const usedEl = document.getElementById('pointsUsed');
    usedEl.textContent = used;
    usedEl.className = used > BUDGET ? 'over' : '';
    document.getElementById('itemCount').textContent = count;
    document.getElementById('potsCovered').textContent = pots.size;
    document.getElementById('submitBtn').disabled = used > BUDGET;
}

function getHighBid(itemId) {
    if (!allBids[itemId]) return 0;
    return Math.max(...Object.values(allBids[itemId]), 0);
}

function getTopN(itemId, n) {
    if (!allBids[itemId]) return [];
    return Object.entries(allBids[itemId])
        .sort((a,b) => b[1] - a[1])
        .slice(0, n)
        .map(e => e[0]);
}

function updateAllStatuses() {
    POTS.forEach(pot => pot.items.forEach(item => {
        const row = document.getElementById('item-' + item.id);
        const highEl = document.getElementById('high-' + item.id);
        if (!row) return;

        const myBid = bids[item.id] || 0;
        const high = getHighBid(item.id);
        const winners = getTopN(item.id, pot.winnersPerItem);

        highEl.innerHTML = high > 0 ? `<span class="high">${high}</span>` : '‚Äî';

        row.classList.remove('has-bid','winning','outbid');
        if (myBid > 0) {
            row.classList.add('has-bid');
            if (winners.includes(teamName)) row.classList.add('winning');
            else row.classList.add('outbid');
        }
    }));
}

// --- TIMER ---
function startTimer() {
    timerInterval = setInterval(() => {
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            document.getElementById('mainContent').classList.add('frozen');
            return;
        }
        timeLeft--;
        const m = Math.floor(timeLeft / 60);
        const s = timeLeft % 60;
        const el = document.getElementById('timer');
        el.textContent = m.toString().padStart(2,'0') + ':' + s.toString().padStart(2,'0');
        if (timeLeft < 120) el.classList.add('warning');
    }, 1000);
}

// --- SUBMIT (form POST, same as previous) ---
function submitBids() {
    const btn = document.getElementById('submitBtn');
    btn.textContent = 'Saving...';

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = API;
    form.target = 'submitFrame';

    const addField = (name, val) => {
        const inp = document.createElement('input');
        inp.type = 'hidden'; inp.name = name; inp.value = val;
        form.appendChild(inp);
    };

    addField('action', 'submitBids');
    addField('teamName', teamName);
    addField('bids', JSON.stringify(bids));

    let iframe = document.getElementById('submitFrame');
    if (!iframe) {
        iframe = document.createElement('iframe');
        iframe.id = 'submitFrame';
        iframe.name = 'submitFrame';
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
    }

    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);

    setTimeout(() => { btn.textContent = 'Update Bids'; poll(); }, 2000);
}

// --- POLL (JSONP, same as previous) ---
function poll() {
    const script = document.createElement('script');
    const cb = 'cb_' + Date.now();

    window[cb] = function(data) {
        if (data && data.bids) {
            allBids = data.bids;
            updateAllStatuses();
            setStatus(true);
        }
        delete window[cb];
        script.remove();
    };

    script.src = API + '?action=getAllBids&callback=' + cb;
    script.onerror = () => { setStatus(false); script.remove(); delete window[cb]; };
    document.body.appendChild(script);
}

function setStatus(ok) {
    const el = document.getElementById('status');
    el.textContent = ok ? 'Connected' : 'Offline';
    el.className = 'status ' + (ok ? 'ok' : 'err');
}

// --- KEYBOARD NAV ---
document.addEventListener('keydown', e => {
    if (e.key === 'Enter' && e.target.classList.contains('bid-input')) {
        const inputs = [...document.querySelectorAll('.bid-input')];
        const idx = inputs.indexOf(e.target);
        if (idx < inputs.length - 1) inputs[idx + 1].focus();
    }
});
</script>
</body>
</html>
